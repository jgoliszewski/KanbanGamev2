@using KanbanGamev2.Client.Services
@inject INotificationService NotificationService
@inject ISignalRService SignalRService
@implements IDisposable

@if (_notifications.Any())
{
    <div class="notification-container">
        @foreach (var notification in _notifications)
        {
            <div class="notification @GetNotificationClass(notification.Type) @(notification.IsGlobal ? "global" : "")" 
                 @key="notification.Id">
                <div class="notification-header">
                    <h6 class="notification-title">@notification.Title</h6>
                    <button class="btn-close notification-close-btn" @onclick="() => RemoveNotification(notification.Id)" title="Close">Ã—</button>
                </div>
                <div class="notification-body">
                    @notification.Message
                </div>
                <div class="notification-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">@notification.Timestamp.ToString("HH:mm:ss")</small>
                        @if (_countdownTimers.ContainsKey(notification.Id))
                        {
                            <small class="text-muted">Auto-dismiss in @_countdownTimers[notification.Id]s</small>
                        }
                    </div>
                    @if (_countdownTimers.ContainsKey(notification.Id))
                    {
                        <div class="progress mt-1" style="height: 2px;">
                            <div class="progress-bar @GetProgressBarClass(notification.Type)" 
                                 style="width: @(_countdownTimers[notification.Id] * 10)%"
                                 role="progressbar"></div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    private List<NotificationMessage> _notifications = new();
    private Dictionary<string, int> _countdownTimers = new();
    private Dictionary<string, Timer> _timers = new();

    protected override void OnInitialized()
    {
        NotificationService.NotificationReceived += OnNotificationReceived;
        SignalRService.GlobalNotificationReceived += OnGlobalNotificationReceived;
    }

    private void OnNotificationReceived(NotificationMessage notification)
    {
        _notifications.Add(notification);
        StartCountdownTimer(notification.Id);
        
        // Auto-remove after 10 seconds for non-global notifications
        if (!notification.IsGlobal)
        {
            _ = Task.Delay(10000).ContinueWith(_ =>
            {
                InvokeAsync(() =>
                {
                    RemoveNotification(notification.Id);
                    StateHasChanged();
                });
            });
        }
        
        StateHasChanged();
    }

    private void OnGlobalNotificationReceived(string title, string message, string type)
    {
        var notificationType = type switch
        {
            "Success" => NotificationType.Success,
            "Warning" => NotificationType.Warning,
            "Error" => NotificationType.Error,
            _ => NotificationType.Info
        };

        var notification = new NotificationMessage
        {
            Title = title,
            Message = message,
            Type = notificationType,
            IsGlobal = true
        };

        _notifications.Add(notification);
        StartCountdownTimer(notification.Id);
        
        // Auto-remove global notifications after 10 seconds
        _ = Task.Delay(10000).ContinueWith(_ =>
        {
            InvokeAsync(() =>
            {
                RemoveNotification(notification.Id);
                StateHasChanged();
            });
        });
        
        StateHasChanged();
    }

    private void RemoveNotification(string id)
    {
        var notification = _notifications.FirstOrDefault(n => n.Id == id);
        if (notification != null)
        {
            _notifications.Remove(notification);
            StopCountdownTimer(id);
            StateHasChanged();
        }
    }

    private string GetNotificationClass(NotificationType type)
    {
        return type switch
        {
            NotificationType.Success => "notification-success",
            NotificationType.Warning => "notification-warning",
            NotificationType.Error => "notification-error",
            _ => "notification-info"
        };
    }

    private string GetProgressBarClass(NotificationType type)
    {
        return type switch
        {
            NotificationType.Success => "bg-success",
            NotificationType.Warning => "bg-warning",
            NotificationType.Error => "bg-danger",
            _ => "bg-info"
        };
    }

    private void StartCountdownTimer(string notificationId)
    {
        _countdownTimers[notificationId] = 10;
        
        var timer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                if (_countdownTimers.ContainsKey(notificationId))
                {
                    _countdownTimers[notificationId]--;
                    if (_countdownTimers[notificationId] <= 0)
                    {
                        _countdownTimers.Remove(notificationId);
                    }
                    StateHasChanged();
                }
            });
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
        
        _timers[notificationId] = timer;
    }

    private void StopCountdownTimer(string notificationId)
    {
        if (_timers.ContainsKey(notificationId))
        {
            _timers[notificationId]?.Dispose();
            _timers.Remove(notificationId);
        }
        
        if (_countdownTimers.ContainsKey(notificationId))
        {
            _countdownTimers.Remove(notificationId);
        }
    }

    public void Dispose()
    {
        NotificationService.NotificationReceived -= OnNotificationReceived;
        SignalRService.GlobalNotificationReceived -= OnGlobalNotificationReceived;
        
        // Clean up all timers
        foreach (var timer in _timers.Values)
        {
            timer?.Dispose();
        }
        _timers.Clear();
        _countdownTimers.Clear();
    }
} 