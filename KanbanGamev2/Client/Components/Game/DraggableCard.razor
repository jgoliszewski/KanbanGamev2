@using KanbanGame.Shared
@using KanbanGamev2.Client.Services
@inject IDragDropService DragDropService
@inject ISignalRService SignalRService
@inject IFeatureService FeatureService
@inject ITaskService TaskService
@inject IEmployeeService EmployeeService
@inject KanbanGamev2.Shared.Services.IGameStateService GameStateService

<div class="draggable-card @(IsDragging ? "dragging" : "") @(IsAssignedWorkItem ? "assigned-work-item" : "") @(IsDragOverEmployee ? "drag-over-employee" : "") @(ShouldBeGrayedOut ? "not-draggable" : "") @(Card is Employee ? "employee-card-wrapper" : "")"
     draggable="@GetDraggableValue()"
     @ondragstart="OnDragStart"
     @ondragend="OnDragEnd"
     @ondragover="OnDragOver"
     @ondragover:preventDefault
     @ondragleave="OnDragLeave"
     @ondrop="OnDrop"
     @ondrop:preventDefault>
    <div class="card mb-2">
        <div class="card-body p-2">
            @if (Card is Employee employee)
            {
                <div class="employee-card @(employee.IsWorking ? "assigned" : "") @(employee.IsLearning ? "learning" : "") @(employee.IsChangingTeams ? "changing-teams" : "") @(employee.IsLearningInOtherTeam ? "learning-other-team" : "")">
                    <div class="employee-top">
                        <div class="employee-left">
                            <div class="employee-avatar-container">
                                <img src="@GetEmployeeAvatar(employee.Name)" alt="@employee.Name" class="employee-avatar" />
                                @if (!employee.IsLearningInOtherTeam && !employee.IsChangingTeams && !employee.IsLearning)
                                {
                                    <span class="@(employee.IsWorking ? "status-dot-working" : "status-dot-free") status-dot-on-avatar" 
                                          title="@(employee.IsWorking ? "Working" : "Free")">
                                    </span>
                                }
                            </div>
                            <div class="employee-info-left">
                                <div class="employee-name">@GetFirstName(employee.Name)</div>
                        <div class="employee-seniority">
                            <span class="badge @GetSeniorityBadgeClass(employee.Seniority)">
                                @employee.Seniority.GetDisplayName()
                            </span>
                        </div>
                            </div>
                        </div>
                        <div class="employee-right">
                        <div class="employee-status">
                            @if (!employee.IsLearningInOtherTeam && !employee.IsChangingTeams && !employee.IsLearning)
                            {
                                <button class="btn btn-sm btn-outline-primary move-employee-btn" 
                                        @onclick="() => ShowMoveModal(employee)" 
                                        disabled="@(employee.IsChangingTeams || employee.IsLearningInOtherTeam || (employee.IsLearning && employee.LearningDays >= 1))"
                                        title="@(employee.IsChangingTeams || employee.IsLearningInOtherTeam || (employee.IsLearning && employee.LearningDays >= 1) ? "Cannot move while changing teams or learning" : "Move Employee")">
                                    <i class="oi oi-arrow-right"></i>
                                </button>
                            }
                            </div>
                        </div>
                    </div>
                    <div class="employee-bottom">
                        <div class="role-badges-container">
                            <RoleBadges Employee="@employee" />
                        </div>
                        @if (employee.IsLearningInOtherTeam || employee.IsChangingTeams || employee.IsLearning)
                        {
                            <div class="employee-status-badges">
                                @if (employee.IsLearningInOtherTeam)
                                {
                                    <div class="d-flex flex-column align-items-center gap-1">
                                        <small class="text-muted" style="font-size: 0.7rem; line-height: 1;">
                                            Day @employee.LearningDays / @Employee.DaysRequiredToLearnRole
                                        </small>
                                        <span class="badge bg-info" title="Learning in Other Team">
                                            <i class="oi oi-book"></i> Learning
                                        </span>
                                    </div>
                                }
                                else if (employee.IsChangingTeams)
                                {
                                    <div class="d-flex flex-column align-items-center gap-1">
                                        <small class="text-muted" style="font-size: 0.7rem; line-height: 1;">
                                            Day @employee.ChangingTeamsDays / @Employee.DaysRequiredToChangeTeams
                                        </small>
                                        <span class="badge bg-warning" title="Changing Teams">
                                            <i class="oi oi-people"></i> Changing Teams
                                        </span>
                                    </div>
                                }
                                else if (employee.IsLearning)
                                {
                                    <div class="d-flex flex-column align-items-center gap-1">
                                        <small class="text-muted" style="font-size: 0.7rem; line-height: 1;">
                                            Day @employee.LearningDays / @Employee.DaysRequiredToLearnRole
                                        </small>
                                        <span class="badge bg-info" title="Learning">
                                            <i class="oi oi-book"></i> Learning
                                        </span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <h6 class="card-title mb-1">@Card.Title</h6>
                @if (!(Card is Feature) && !(Card is KanbanTask))
                {
                    <p class="card-text small mb-1">@Card.Description</p>
                }
                @if (Card is Feature feature)
                {
                    <div class="d-flex justify-content-between align-items-center">
                        @if (feature.Priority.HasValue)
                        {
                            <span class="badge @feature.Priority.GetBadgeClass()">@feature.Priority</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">No Priority</span>
                        }
                        @if (feature.ColumnId != "backlog" && feature.ColumnId != "analysis1" && feature.ColumnId != "analysis2")
                        {
                            <small class="text-muted">@feature.StoryPoints SP</small>
                        }
                    </div>
                    @if (feature.ColumnId != "backlog" && feature.ColumnId != "analysis1" && feature.ColumnId != "analysis2" && feature.DueDate.HasValue)
                    {
                        <div class="mt-1">
                            <small class="@GetDeadlineClass(feature.DueDate.Value)">
                                <i class="oi oi-calendar"></i> Due: @GetDeadlineText(feature.DueDate.Value)
                            </small>
                        </div>
                    }
                    @if (feature.IsInReadyDevColumn)
                    {
                        <div class="mt-2">
                            <div class="text-success fw-bold">Profit: $@feature.Profit.ToString("N0")</div>
                            <button class="btn btn-primary btn-sm w-100 mt-1" @onclick="async () => await SendToDevelopment(feature)" @onclick:stopPropagation="true">
                                Send to Development
                            </button>
                        </div>
                    }
                    else if (feature.IsInDevelopment)
                    {
                        <div class="mt-2">
                            <div class="text-success fw-bold">Profit: $@feature.Profit.ToString("N0")</div>
                        </div>
                    }
                    @if (feature.IsAssigned)
                    {
                        <span class="badge bg-success">Assigned</span>
                    }
                }
                else if (Card is KanbanTask task)
                {
                    <div class="d-flex justify-content-between align-items-center">
                        <select class="form-select form-select-sm priority-select @task.Priority.GetBadgeClass()" 
                                style="width: auto; display: inline-block; padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                @bind="task.Priority"
                                @bind:event="onchange"
                                @bind:after="async () => await OnTaskPriorityChanged(task)"
                                @onclick:stopPropagation="true">
                            @foreach (Priority priority in Enum.GetValues(typeof(Priority)))
                            {
                                <option value="@priority">@priority</option>
                            }
                        </select>
                        <small class="text-muted">@task.StoryPoints SP</small>
                    </div>
                    @if (task.AssignedToEmployeeId.HasValue)
                    {
                        <span class="badge bg-success">Assigned</span>
                    }


                    
                    @if (task.HasDependency && !task.IsDependencySatisfied && !task.CanBeMoved)
                    {
                        <div class="mt-2">
                            @{
                            var dependencyTask = TaskService.Tasks.FirstOrDefault(t => t.Id == task.DependsOnTaskId!.Value);
                            <span class="badge bg-danger">Blocked by @dependencyTask?.Title</span>
                            }
                        </div>
                    }
                }
            }
        </div>
    </div>
</div>

<MoveEmployeeModal 
    IsVisible="@showMoveModal"
    Employee="@selectedEmployee"
    CurrentBoardType="@BoardType"
    OnCancel="@(() => showMoveModal = false)"
    OnConfirm="@OnEmployeeMoveConfirmed" />

@code {
    [Parameter] public Card Card { get; set; } = null!;
    [Parameter] public string ColumnId { get; set; } = string.Empty;
    [Parameter] public BoardType BoardType { get; set; }
    [Parameter] public EventCallback<(Card card, string fromColumn, string toColumn)> OnCardMoved { get; set; }
    [Parameter] public EventCallback<(Card workCard, Employee employee)> OnWorkAssigned { get; set; }

    private bool IsDragging => DragDropService.IsDragging && DragDropService.DraggedCard?.Id == Card.Id;
    private bool IsDraggable 
    {
        get
        {
            // Summary board is read-only
            if (DragDropService.IsReadOnlyBoard(BoardType))
                return false;
            
            // Tasks that can't be moved
            if (Card is KanbanTask task && !task.CanBeMoved)
                return false;
            
            // Employees: check if they can be dragged
            if (Card is Employee employee)
            {
                // Cannot drag employees who are onboarding
                if (employee.IsOnboarding)
                    return false;
                    
                // Cannot drag employees who are changing teams
                if (employee.Status == EmployeeStatus.ChangingTeams)
                    return false;
                    
                // Cannot drag employees who are learning in other team
                if (employee.Status == EmployeeStatus.IsLearningInOtherTeam)
                    return false;
                    
                // Cannot drag employees who have started learning (day counter >= 1)
                if (employee.Status == EmployeeStatus.IsLearning && employee.LearningDays >= 1)
                    return false;
                    
                // Cannot drag employees who are working
                if (employee.IsWorking)
                    return false;
            }
            
            return true;
        }
    }

    private bool ShouldBeGrayedOut
    {
        get
        {
            // Don't gray out if draggable
            if (IsDraggable)
                return false;
            
            // Exception: Don't gray out working employees
            if (Card is Employee employee && employee.IsWorking)
                return false;
            
            // Gray out all other non-draggable cards
            return true;
        }
    }

    private bool IsDragOverEmployee => DragDropService.IsDragging && 
                                      Card is Employee && 
                                      DragDropService.DragOverTargetId == Card.Id.ToString() &&
                                      DragDropService.DragOverTargetType == DragOverTargetType.Employee &&
                                      (DragDropService.DraggedCard is KanbanTask || DragDropService.DraggedCard is Feature) &&
                                      DragDropService.CanMoveWorkForward(BoardType, DragDropService.DraggedCard, (Employee)Card);

    private bool IsAssignedWorkItem
    {
        get
        {
            if (Card is KanbanTask task)
                return task.AssignedToEmployeeId.HasValue;
            if (Card is Feature feature)
                return feature.AssignedToEmployeeId.HasValue;
            return false;
        }
    }

    private string GetEmployeeAvatar(string employeeName)
    {
        return $"Avatars/{employeeName}.png";
    }

    private string GetFirstName(string fullName)
    {
        return fullName.Split(' ').FirstOrDefault() ?? fullName;
    }

    private string GetDraggableValue()
    {
        return IsDraggable ? "true" : "false";
    }

    private void OnDragStart(DragEventArgs e)
    {
        // Prevent dragging if not draggable
        if (!IsDraggable)
        {
            e.DataTransfer.EffectAllowed = "none";
            return;
        }
        
        if (Card is KanbanTask task && !task.CanBeMoved)
        {
            e.DataTransfer.EffectAllowed = "none";
            return;
        }
        
        if (Card is Employee employee)
        {
            if (employee.IsChangingTeams || employee.IsWorking || employee.IsLearningInOtherTeam)
            {
                e.DataTransfer.EffectAllowed = "none";
                return;
            }
            
            // Prevent dragging if employee has started learning (day counter >= 1)
            if (employee.Status == EmployeeStatus.IsLearning && employee.LearningDays >= 1)
            {
                e.DataTransfer.EffectAllowed = "none";
                return;
            }
        }
        
        DragDropService.StartDrag(Card, ColumnId);
        e.DataTransfer.EffectAllowed = "move";
        StateHasChanged();
    }

    private void OnDragEnd(DragEventArgs e)
    {
        // Only clear the drag state, don't handle the movement here
        // The OnDrop event in DroppableColumn will handle the actual movement
        DragDropService.ClearDrag();
        StateHasChanged();
    }

    private void OnDragOver(DragEventArgs e)
    {
        // Set drag-over target for employee highlighting
        if (DragDropService.IsDragging && Card is Employee && 
            (DragDropService.DraggedCard is KanbanTask || DragDropService.DraggedCard is Feature))
        {
            DragDropService.SetDragOverTarget(Card.Id.ToString(), DragOverTargetType.Employee);
        }
        
        // Trigger state change to update the drag-over highlighting
        StateHasChanged();
    }

    private void OnDragLeave(DragEventArgs e)
    {
        // Clear drag-over state when the draggable card is no longer over a droppable area
        DragDropService.ClearDragOver();
        StateHasChanged();
    }

    private async void OnDrop(DragEventArgs e)
    {
        // Handle work assignment if dragging a task/feature onto an employee
        if (DragDropService.IsDragging && DragDropService.DraggedCard != null)
        {
            var draggedCard = DragDropService.DraggedCard;
            
            // Check if we're dropping a task/feature onto an employee
            if ((draggedCard is KanbanTask || draggedCard is Feature) && Card is Employee employee)
            {
                if (DragDropService.CanMoveWorkForward(BoardType, draggedCard, employee))
                {
                    // Move the work to the employee's column and assign it
                    draggedCard.ColumnId = employee.ColumnId;
                    DragDropService.AssignWorkToEmployee(draggedCard, employee);
                    await OnWorkAssigned.InvokeAsync((draggedCard, employee));
                    
                    // Notify other players about the work assignment
                    await SignalRService.NotifyBoardUpdateAsync(BoardType.ToString(), employee.ColumnId, draggedCard);
                    
                    StateHasChanged();
                }
            }
            // Check if we're dropping an employee onto a task/feature
            else if (draggedCard is Employee draggedEmployee && (Card is KanbanTask || Card is Feature))
            {
                if (DragDropService.CanMoveWorkForward(BoardType, Card, draggedEmployee))
                {
                    // Move the work to the employee's column and assign it
                    Card.ColumnId = draggedEmployee.ColumnId;
                    DragDropService.AssignWorkToEmployee(Card, draggedEmployee);
                    await OnWorkAssigned.InvokeAsync((Card, draggedEmployee));
                    
                    // Notify other players about the work assignment
                    await SignalRService.NotifyBoardUpdateAsync(BoardType.ToString(), draggedEmployee.ColumnId, Card);
                    
                    StateHasChanged();
                }
            }
        }
    }

    private string GetPriorityBadgeClass(Priority priority)
    {
        return priority switch
        {
            Priority.High => "bg-danger",
            Priority.Medium => "bg-warning",
            Priority.Low => "bg-info",
            _ => "bg-secondary"
        };
    }

    private string GetSeniorityBadgeClass(Seniority seniority)
    {
        return seniority switch
        {
            Seniority.Junior => "bg-info",
            Seniority.Mid => "bg-warning",
            Seniority.Senior => "bg-success",
            _ => "bg-secondary"
        };
    }

    private async Task SendToDevelopment(Feature feature)
    {
        await FeatureService.SendFeatureToDevelopment(feature);
        
        // Force a UI refresh
        StateHasChanged();
    }

    // Employee move functionality
    private bool showMoveModal = false;
    private Employee? selectedEmployee = null;

    private void ShowMoveModal(Employee employee)
    {
        selectedEmployee = employee;
        showMoveModal = true;
        StateHasChanged();
    }

    private async Task OnEmployeeMoveConfirmed((Employee employee, BoardType boardType, string columnId) moveData)
    {
        try
        {
            // Store the original board type before moving
            var originalBoardType = BoardType;
            
            await EmployeeService.MoveEmployee(moveData.employee.Id, moveData.boardType, moveData.columnId);
            
            // Notify other players about the employee move - include original board info
            await SignalRService.NotifyEmployeeMoveAsync(moveData.employee, moveData.boardType, moveData.columnId, originalBoardType);
            
            showMoveModal = false;
            selectedEmployee = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // Handle error - you might want to show a toast notification
            Console.WriteLine($"Error moving employee: {ex.Message}");
        }
    }


    private async Task OnTaskPriorityChanged(KanbanTask task)
    {
        await TaskService.UpdateTask(task);
        StateHasChanged();
    }

    private string GetDeadlineText(DateTime dueDate)
    {
        var currentGameDate = GameStateService.GameStartDate.AddDays(GameStateService.CurrentDay - 1);
        var daysUntilDeadline = (dueDate.Date - currentGameDate.Date).Days;
        
        if (daysUntilDeadline < 0)
        {
            return $"Overdue ({Math.Abs(daysUntilDeadline)} day{(Math.Abs(daysUntilDeadline) == 1 ? "" : "s")} ago)";
        }
        else if (daysUntilDeadline == 0)
        {
            return "Today";
        }
        else if (daysUntilDeadline == 1)
        {
            return "Tomorrow";
        }
        else if (daysUntilDeadline <= 7)
        {
            return $"{daysUntilDeadline} days ({dueDate:MM/dd/yyyy})";
        }
        else
        {
            return dueDate.ToString("MM/dd/yyyy");
        }
    }

    private string GetDeadlineClass(DateTime dueDate)
    {
        var currentGameDate = GameStateService.GameStartDate.AddDays(GameStateService.CurrentDay - 1);
        var daysUntilDeadline = (dueDate.Date - currentGameDate.Date).Days;
        
        if (daysUntilDeadline < 0)
        {
            return "text-danger fw-bold";
        }
        else if (daysUntilDeadline <= 3)
        {
            return "text-danger";
        }
        else
        {
            return "text-muted";
        }
    }
} 