@using KanbanGame.Shared
@using KanbanGamev2.Client.Services
@inject ITaskService TaskService
@inject IFeatureService FeatureService
@inject KanbanGamev2.Shared.Services.IGameStateService GameStateService

<div class="card mb-2 summary-feature-card">
    <div class="card-body p-2">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="card-title mb-0">@Feature.Title</h6>
            <div class="text-success fw-bold">$@Feature.Profit.ToString("N0")</div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-2">
            @if (Feature.Priority.HasValue)
            {
                <span class="badge @Feature.Priority.GetBadgeClass()">@Feature.Priority</span>
            }
            else
            {
                <span class="badge bg-secondary">No Priority</span>
            }
            @if (Feature.ColumnId != "backlog" && Feature.ColumnId != "analysis1" && Feature.ColumnId != "analysis2")
            {
                <small class="text-muted">@Feature.StoryPoints SP</small>
            }
        </div>
        
        @if (Feature.ColumnId != "backlog" && Feature.ColumnId != "analysis1" && Feature.ColumnId != "analysis2" && Feature.DueDate.HasValue)
        {
            <div class="mb-2">
                <small class="@GetDeadlineClass(Feature.DueDate.Value)">
                    <i class="oi oi-calendar"></i> Due: @GetDeadlineText(Feature.DueDate.Value)
                </small>
            </div>
        }
        
        @if (Feature.IsAssigned)
        {
            <span class="badge bg-success mb-2">Assigned</span>
        }
        
        <!-- Show tasks for this feature -->
        @{
            var featureTasks = GetFeatureTasks(Feature.Id);
        }
        
        @if (featureTasks.Any())
        {
            <div class="feature-tasks mt-2">
                <h6 class="text-muted mb-2">
                    <span class="oi oi-list" aria-hidden="true"></span>
                    Tasks (@featureTasks.Count)
                </h6>
                <div class="task-grid">
                    @foreach (var task in featureTasks)
                    {
                        <div class="task-item @(task.IsInDoneColumn ? "completed" : "") @(task.HasDependency && !task.IsDependencySatisfied ? "blocked" : "")">
                            <div class="task-header">
                                <small class="fw-bold">@task.Title</small>
                                <div class="task-status">
                                    @if (task.HasDependency && !task.IsDependencySatisfied && !task.CanBeMoved)
                                    {
                                        <span class="badge bg-danger badge-sm" title="Blocked by dependency">
                                            <span class="oi oi-lock-locked" aria-hidden="true"></span>
                                        </span>
                                    }
                                </div>
                            </div>
                            <div class="task-meta">
                                <small class="text-muted">@task.StoryPoints SP</small>
                                @if (task.IsAssigned)
                                {
                                    <span class="badge bg-success badge-sm">Assigned</span>
                                }
                            </div>
                            <!-- Show dependency information -->
                            @if (task.HasDependency)
                            {
                                var dependencyTask = TaskService.Tasks.FirstOrDefault(t => t.Id == task.DependsOnTaskId!.Value);
                                <div class="dependency-info mt-1">
                                    @if (task.IsDependencySatisfied)
                                    {
                                        <small class="text-success">
                                            <span class="oi oi-check" aria-hidden="true"></span>
                                            Depends on: @dependencyTask?.Title
                                        </small>
                                    }
                                    else
                                    {
                                        <small class="text-danger">
                                            <span class="oi oi-lock-locked" aria-hidden="true"></span>
                                            Blocked by: @dependencyTask?.Title
                                        </small>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<style>
    .summary-feature-card {
        border-left: 4px solid #2196f3;
    }
    
    .task-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .task-item {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
    }
    
    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 4px;
    }
    
    .task-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: auto;
    }
    
    .task-item.completed {
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    
    .task-item.blocked {
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .badge-sm {
        font-size: 0.65rem;
        padding: 0.25rem 0.4rem;
    }
    
    .dependency-info {
        font-size: 0.75rem;
    }
    
    .task-info small {
        font-size: 0.8rem;
    }
</style>

@code {
    [Parameter] public Feature Feature { get; set; } = null!;
    
    private List<KanbanTask> GetFeatureTasks(Guid featureId)
    {
        return TaskService.Tasks
            .Where(t => t.FeatureId == featureId)
            .OrderBy(t => t.Priority)
            .ThenBy(t => t.Title)
            .ToList();
    }

    private string GetDeadlineText(DateTime dueDate)
    {
        var currentGameDate = GameStateService.GameStartDate.AddDays(GameStateService.CurrentDay - 1);
        var daysUntilDeadline = (dueDate.Date - currentGameDate.Date).Days;
        
        if (daysUntilDeadline < 0)
        {
            return $"Overdue ({Math.Abs(daysUntilDeadline)} day{(Math.Abs(daysUntilDeadline) == 1 ? "" : "s")} ago)";
        }
        else if (daysUntilDeadline == 0)
        {
            return "Today";
        }
        else if (daysUntilDeadline == 1)
        {
            return "Tomorrow";
        }
        else if (daysUntilDeadline <= 7)
        {
            return $"{daysUntilDeadline} days ({dueDate:MM/dd/yyyy})";
        }
        else
        {
            return dueDate.ToString("MM/dd/yyyy");
        }
    }

    private string GetDeadlineClass(DateTime dueDate)
    {
        var currentGameDate = GameStateService.GameStartDate.AddDays(GameStateService.CurrentDay - 1);
        var daysUntilDeadline = (dueDate.Date - currentGameDate.Date).Days;
        
        if (daysUntilDeadline < 0)
        {
            return "text-danger fw-bold";
        }
        else if (daysUntilDeadline <= 3)
        {
            return "text-danger";
        }
        else
        {
            return "text-muted";
        }
    }
}
