@page "/gamemaster"
@using KanbanGame.Shared
@using KanbanGamev2.Client.Services
@using KanbanGamev2.Client.Components
@inject IEmployeeService EmployeeService
@inject INotificationService NotificationService
@inject ISignalRService SignalRService
@inject IGameRestartService GameRestartService
@inject KanbanGamev2.Shared.Services.IGameStateService GameStateService
@inject IFeatureService FeatureService
@inject NavigationManager Navigation
@implements IDisposable
@implements IAsyncDisposable

<PageTitle>Game Master Panel</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="oi oi-crown text-warning"></i> Game Master Panel
                </h2>
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-danger btn-sm" @onclick="ShowRestartConfirmation" title="Restart Game - Reset all progress">
                        <i class="oi oi-reload"></i> Restart Game
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="oi oi-people"></i> Employee Management
                    </h5>
                </div>
                <div class="card-body">
                    @if (_employees == null)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Employee</th>
                                        <th>Roles</th>
                                        <th>Seniority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var employee in _employees)
                                    {
                                        <tr class="@(employee.Status == EmployeeStatus.Fired ? "table-danger" : employee.Status == EmployeeStatus.OnVacation ? "table-warning" : "")">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img src="@GetEmployeeAvatar(employee.Name)" alt="@employee.Name" class="rounded-circle me-3" style="width: 40px; height: 40px;" />
                                                    <div>
                                                        <div class="fw-bold">@employee.Name</div>
                                                        <small class="text-muted">@employee.Email</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex gap-1 flex-wrap">
                                                    @foreach (var role in employee.LearnedRoles)
                                                    {
                                                        <span class="badge @GetRoleBadgeClass(role)">@GetRoleInitial(role)</span>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge @GetSeniorityBadgeClass(employee.Seniority)">
                                                    @employee.Seniority.GetDisplayName()
                                                </span>
                                            </td>
                                            <td>
                                                @switch (employee.Status)
                                                {
                                                    case EmployeeStatus.Active:
                                                        <span class="badge bg-success">Active</span>
                                                        break;
                                                    case EmployeeStatus.OnVacation:
                                                        <div>
                                                            <span class="badge bg-warning mb-1">
                                                                Vacation
                                                            </span>
                                                            @if (employee.VacationEndDate.HasValue)
                                                            {
                                                                var daysLeft = GetDaysLeft(employee.VacationEndDate.Value);
                                                                <div class="small text-muted">
                                                                    @if (daysLeft > 0)
                                                                    {
                                                                        <span class="text-info">
                                                                            <i class="oi oi-clock"></i> @daysLeft day@(daysLeft == 1 ? "" : "s") left
                                                                        </span>
                                                                    }
                                                                    else if (daysLeft == 0)
                                                                    {
                                                                        <span class="text-success">
                                                                            <i class="oi oi-check"></i> Returns today
                                                                        </span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-danger">
                                                                            <i class="oi oi-warning"></i> Overdue (@Math.Abs(daysLeft) day@(Math.Abs(daysLeft) == 1 ? "" : "s") overdue)
                                                                        </span>
                                                                    }
                                                                </div>
                                                            }
                                                        </div>
                                                        break;
                                                    case EmployeeStatus.Fired:
                                                        <span class="badge bg-danger">Fired</span>
                                                        break;
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    @if (employee.Status == EmployeeStatus.Active)
                                                    {
                                                        <button class="btn btn-warning btn-sm" @onclick="() => ShowVacationModal(employee)" title="Send on Vacation">
                                                            <i class="oi oi-sun"></i>
                                                        </button>
                                                        <button class="btn btn-danger btn-sm" @onclick="() => ShowFireModal(employee)" title="Fire Employee">
                                                            <i class="oi oi-x"></i>
                                                        </button>
                                                    }
                                                    else if (employee.Status == EmployeeStatus.OnVacation)
                                                    {
                                                        <button class="btn btn-success btn-sm" @onclick="() => EndVacation(employee)" title="End Vacation Early">
                                                            <i class="oi oi-check"></i>
                                                        </button>
                                                    }
                                                    else if (employee.Status == EmployeeStatus.Fired)
                                                    {
                                                        <button class="btn btn-success btn-sm" @onclick="() => RehireEmployee(employee)" title="Rehire Employee">
                                                            <i class="oi oi-plus"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="oi oi-cog"></i> UI Preferences
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="summaryBoardToggle" 
                                   checked="@_isSummaryBoardVisible" 
                                   @onchange="OnSummaryBoardVisibilityChanged" />
                            <label class="form-check-label" for="summaryBoardToggle">
                                <strong>Show Summary Board in Sidebar</strong>
                            </label>
                            <div class="form-text text-muted">
                                Control whether the Summary Board link appears in the navigation sidebar.
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="readyDevColumnToggle" 
                                   checked="@_isReadyForDevelopmentColumnVisible" 
                                   @onchange="OnReadyForDevelopmentColumnVisibilityChanged" />
                            <label class="form-check-label" for="readyDevColumnToggle">
                                <strong>Show Ready for Development Column</strong>
                            </label>
                            <div class="form-text text-muted">
                                Control whether the "Ready for Development" column appears on the Analysis Board.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="oi oi-list-rich"></i> Backlog Feature Management
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h6 class="mb-3">Add New Feature to Backlog</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary" @onclick="() => AddFeatureToBacklog(3, 6000)" title="Very Small Feature - 3 Story Points">
                            <i class="oi oi-plus"></i> Very Small
                        </button>
                        <button class="btn btn-outline-primary" @onclick="() => AddFeatureToBacklog(5, 10000)" title="Small Feature - 5 Story Points">
                            <i class="oi oi-plus"></i> Small
                        </button>
                        <button class="btn btn-outline-primary" @onclick="() => AddFeatureToBacklog(8, 15000)" title="Medium Feature - 8 Story Points">
                            <i class="oi oi-plus"></i> Medium
                        </button>
                        <button class="btn btn-outline-primary" @onclick="() => AddFeatureToBacklog(13, 25000)" title="Large Feature - 13 Story Points">
                            <i class="oi oi-plus"></i> Large
                        </button>
                        <button class="btn btn-outline-primary" @onclick="() => AddFeatureToBacklog(21, 40000)" title="Very Large Feature - 21 Story Points">
                            <i class="oi oi-plus"></i> Very Large
                        </button>
                    </div>
                </div>
                
                <div>
                    <h6 class="mb-3">Existing Features</h6>
                    @if (_features == null || _features.Count == 0)
                    {
                        <p class="text-muted">No features available. Use the buttons above to add features to backlog.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Title</th>
                                        <th>Description</th>
                                        <th>Column</th>
                                        <th>Story Points</th>
                                        <th>Profit</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var feature in _features)
                                    {
                                        <tr>
                                            <td><strong>@feature.Title</strong></td>
                                            <td>@feature.Description</td>
                                            <td>
                                                <span class="badge @GetColumnBadgeClass(feature.ColumnId)">@GetColumnName(feature.ColumnId)</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">@feature.StoryPoints SP</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">$@feature.Profit.ToString("N0")</span>
                                            </td>
                                            <td>
                                                @if (feature.ColumnId == "backlog")
                                                {
                                                    <button class="btn btn-danger btn-sm" @onclick="() => RemoveFeature(feature.Id)" title="Remove Feature">
                                                        <i class="oi oi-trash"></i> Remove
                                                    </button>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (_showVacationModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="oi oi-sun"></i> Send Employee on Vacation
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseVacationModal"></button>
                </div>
                <div class="modal-body">
                    <p>Send <strong>@_selectedEmployee?.Name</strong> on vacation?</p>
                    <div class="mb-3">
                        <label class="form-label">Vacation Duration</label>
                        <select class="form-select" @bind="_vacationDuration">
                            <option value="7">1 Week</option>
                            <option value="14">2 Weeks</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseVacationModal">Cancel</button>
                    <button type="button" class="btn btn-warning" @onclick="SendOnVacation">Send on Vacation</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@if (_showFireModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="oi oi-x"></i> Fire Employee
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseFireModal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">Warning: This action cannot be undone!</h6>
                        <p class="mb-0">Are you sure you want to fire <strong>@_selectedEmployee?.Name</strong>?</p>
                    </div>
                    <p class="text-muted small">
                        The employee will be removed from all boards and their work will be unassigned.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseFireModal">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="FireEmployee">Fire Employee</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<RestartConfirmationModal 
    IsVisible="@_showRestartConfirmation" 
    IsVisibleChanged="@((bool value) => _showRestartConfirmation = value)"
    OnRestartConfirmed="RestartGame" />

@code {
    private List<Employee>? _employees;
    private bool _showVacationModal = false;
    private bool _showFireModal = false;
    private bool _showRestartConfirmation = false;
    private Employee? _selectedEmployee;
    private int _vacationDuration = 7;
    private bool _isSummaryBoardVisible = true; // New field for checkbox state
    private bool _isReadyForDevelopmentColumnVisible = true; // New field for ready dev column checkbox state
    private List<Feature>? _features;

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
        await LoadFeatures();
        await GameStateService.LoadGameState(); // Load the current game state
        _isSummaryBoardVisible = GameStateService.IsSummaryBoardVisible; // Initialize the checkbox state
        _isReadyForDevelopmentColumnVisible = GameStateService.IsReadyForDevelopmentColumnVisible; // Initialize the ready dev column checkbox state
        SignalRService.EmployeeStatusChanged += OnEmployeeStatusChanged;
        GameStateService.SummaryBoardVisibilityChanged += OnGameStateSummaryBoardVisibilityChanged;
        GameStateService.ReadyForDevelopmentColumnVisibilityChanged += OnGameStateReadyForDevelopmentColumnVisibilityChanged;
    }

    private async Task LoadFeatures()
    {
        try
        {
            await FeatureService.GetFeatures();
            // Show all features except delivered ones (where ColumnId contains "done")
            _features = FeatureService.Features
                .Where(f => !f.IsDelivered) // Exclude delivered features
                .OrderBy(f => f.Order)
                .ToList();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading features: {ex.Message}");
        }
    }

    private async Task AddFeatureToBacklog(int storyPoints, decimal profit)
    {
        try
        {
            // Generate feature title (F + next number)
            var existingFeatures = FeatureService.Features;
            var maxOrder = existingFeatures.Any() ? existingFeatures.Max(f => f.Order) : 0;
            var featureNumber = existingFeatures.Count(f => f.ColumnId == "backlog") + 1;
            
            var newFeature = new Feature
            {
                Title = $"F{maxOrder + 1}",
                Description = $"New feature - {GetSizeName(storyPoints)} size",
                Priority = null,
                Status = Status.ToDo,
                AssignedToEmployeeId = null,
                DueDate = null,
                StoryPoints = storyPoints,
                ColumnId = "backlog",
                Order = maxOrder + 1,
                LaborIntensity = 1.0,
                LaborLeft = 1.0,
                Profit = profit
            };

            await FeatureService.CreateFeature(newFeature);
            await NotificationService.ShowGlobalNotificationAsync(
                "Feature Added",
                $"Added {GetSizeName(storyPoints)} feature ({storyPoints} SP) to backlog.",
                NotificationType.Success
            );
            
            await LoadFeatures();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding feature: {ex.Message}");
            await NotificationService.ShowGlobalNotificationAsync(
                "Error",
                $"Failed to add feature: {ex.Message}",
                NotificationType.Error
            );
        }
    }

    private async Task RemoveFeature(Guid featureId)
    {
        try
        {
            var feature = _features?.FirstOrDefault(f => f.Id == featureId);
            if (feature == null || feature.ColumnId != "backlog") return;

            var success = await FeatureService.DeleteFeature(featureId);
            if (success)
            {
                await NotificationService.ShowGlobalNotificationAsync(
                    "Feature Removed",
                    $"Feature '{feature.Title}' has been removed from backlog.",
                    NotificationType.Info
                );
                await LoadFeatures();
            }
            else
            {
                await NotificationService.ShowGlobalNotificationAsync(
                    "Error",
                    "Failed to remove feature.",
                    NotificationType.Error
                );
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing feature: {ex.Message}");
            await NotificationService.ShowGlobalNotificationAsync(
                "Error",
                $"Failed to remove feature: {ex.Message}",
                NotificationType.Error
            );
        }
    }

    private string GetColumnName(string? columnId)
    {
        if (string.IsNullOrEmpty(columnId))
            return "Unknown";
            
        return columnId switch
        {
            "backlog" => "Backlog",
            "ready-dev" => "Ready for Dev",
            "development" => "Development",
            "done" => "Done",
            _ => columnId
        };
    }

    private string GetColumnBadgeClass(string? columnId)
    {
        if (string.IsNullOrEmpty(columnId))
            return "bg-secondary";
            
        return columnId switch
        {
            "backlog" => "bg-secondary",
            "ready-dev" => "bg-warning",
            "development" => "bg-primary",
            "done" => "bg-success",
            _ => "bg-secondary"
        };
    }

    private string GetSizeName(int storyPoints)
    {
        return storyPoints switch
        {
            3 => "Very Small",
            5 => "Small",
            8 => "Medium",
            13 => "Large",
            21 => "Very Large",
            _ => "Unknown"
        };
    }

    private async Task LoadEmployees()
    {
        try
        {
            await EmployeeService.GetEmployees();
            _employees = EmployeeService.Employees;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading employees: {ex.Message}");
        }
    }

    private void ShowVacationModal(Employee employee)
    {
        _selectedEmployee = employee;
        _showVacationModal = true;
        StateHasChanged();
    }

    private void CloseVacationModal()
    {
        _showVacationModal = false;
        _selectedEmployee = null;
        StateHasChanged();
    }

    private void ShowFireModal(Employee employee)
    {
        _selectedEmployee = employee;
        _showFireModal = true;
        StateHasChanged();
    }

    private void CloseFireModal()
    {
        _showFireModal = false;
        _selectedEmployee = null;
        StateHasChanged();
    }

    private async Task SendOnVacation()
    {
        if (_selectedEmployee == null) return;

        try
        {
            await EmployeeService.SendEmployeeOnVacationAsync(_selectedEmployee.Id, _vacationDuration);
            await NotificationService.ShowGlobalNotificationAsync(
                "Employee Vacation", 
                $"{_selectedEmployee.Name} has been sent on vacation for {(_vacationDuration == 7 ? "1 week" : "2 weeks")}.", 
                NotificationType.Info
            );
            
            CloseVacationModal();
            await LoadEmployees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending employee on vacation: {ex.Message}");
        }
    }

    private async Task FireEmployee()
    {
        if (_selectedEmployee == null) return;

        try
        {
            await EmployeeService.FireEmployeeAsync(_selectedEmployee.Id);
            await NotificationService.ShowGlobalNotificationAsync(
                "Employee Fired", 
                $"{_selectedEmployee.Name} has been fired from the company.", 
                NotificationType.Warning
            );
            
            CloseFireModal();
            await LoadEmployees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error firing employee: {ex.Message}");
        }
    }

    private async Task EndVacation(Employee employee)
    {
        try
        {
            await EmployeeService.EndEmployeeVacationAsync(employee.Id);
            await NotificationService.ShowGlobalNotificationAsync(
                "Vacation Ended", 
                $"{employee.Name} has returned from vacation and is now active.", 
                NotificationType.Success
            );
            
            await LoadEmployees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error ending vacation: {ex.Message}");
        }
    }

    private async Task RehireEmployee(Employee employee)
    {
        try
        {
            await EmployeeService.RehireEmployeeAsync(employee.Id);
            await NotificationService.ShowGlobalNotificationAsync(
                "Employee Rehired", 
                $"{employee.Name} has been rehired and is now active.", 
                                NotificationType.Success
            );
            
            await LoadEmployees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rehiring employee: {ex.Message}");
        }
    }

    private void OnEmployeeStatusChanged(Employee employee, EmployeeStatus oldStatus, EmployeeStatus newStatus)
    {
        // Refresh the employee list when status changes
        _ = InvokeAsync(async () =>
        {
            await LoadEmployees();
            StateHasChanged();
        });
    }

    private void OnGameStateSummaryBoardVisibilityChanged(bool isVisible)
    {
        _isSummaryBoardVisible = isVisible;
        StateHasChanged();
    }

    private void OnGameStateReadyForDevelopmentColumnVisibilityChanged(bool isVisible)
    {
        _isReadyForDevelopmentColumnVisible = isVisible;
        StateHasChanged();
    }

    private string GetEmployeeAvatar(string employeeName)
    {
        return $"Avatars/{employeeName}.png";
    }

    private string GetRoleBadgeClass(Role role)
    {
        return role switch
        {
            Role.HighLevelAnalyst => "bg-warning",
            Role.Analyst => "bg-success",
            Role.Developer => "bg-primary",
            Role.Tester => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetRoleInitial(Role role)
    {
        return role switch
        {
            Role.HighLevelAnalyst => "H",
            Role.Analyst => "A",
            Role.Developer => "D",
            Role.Tester => "T",
            _ => "?"
        };
    }

    private string GetSeniorityBadgeClass(Seniority seniority)
    {
        return seniority switch
        {
            Seniority.Junior => "bg-info",
            Seniority.Mid => "bg-warning",
            Seniority.Senior => "bg-success",
            _ => "bg-secondary"
        };
    }

    private int GetDaysLeft(DateTime vacationEndDate)
    {
        var now = DateTime.Today;
        var timeLeft = vacationEndDate.Date - now;
        return (int)timeLeft.TotalDays;
    }

    private async Task OnSummaryBoardVisibilityChanged(ChangeEventArgs e)
    {
        if (e.Value is bool isVisible)
        {
            _isSummaryBoardVisible = isVisible;
            await GameStateService.SetSummaryBoardVisibility(_isSummaryBoardVisible);
        }
    }

    private async Task OnReadyForDevelopmentColumnVisibilityChanged(ChangeEventArgs e)
    {
        if (e.Value is bool isVisible)
        {
            _isReadyForDevelopmentColumnVisible = isVisible;
            await GameStateService.SetReadyForDevelopmentColumnVisibility(_isReadyForDevelopmentColumnVisible);
        }
    }

    private void ShowRestartConfirmation()
    {
        _showRestartConfirmation = true;
    }

    private async Task RestartGame()
    {
        var success = await GameRestartService.RestartGameAsync();
        if (success)
        {
            // Reload the page to show the new state
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
    }

    public void Dispose()
    {
        SignalRService.EmployeeStatusChanged -= OnEmployeeStatusChanged;
        GameStateService.SummaryBoardVisibilityChanged -= OnGameStateSummaryBoardVisibilityChanged;
        GameStateService.ReadyForDevelopmentColumnVisibilityChanged -= OnGameStateReadyForDevelopmentColumnVisibilityChanged;
    }

    public async ValueTask DisposeAsync()
    {
        SignalRService.EmployeeStatusChanged -= OnEmployeeStatusChanged;
        GameStateService.SummaryBoardVisibilityChanged -= OnGameStateSummaryBoardVisibilityChanged;
        GameStateService.ReadyForDevelopmentColumnVisibilityChanged -= OnGameStateReadyForDevelopmentColumnVisibilityChanged;
        await Task.CompletedTask;
    }
} 