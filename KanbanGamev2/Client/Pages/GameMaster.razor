@page "/gamemaster"
@using KanbanGame.Shared
@using KanbanGamev2.Client.Services
@using KanbanGamev2.Client.Components
@inject IEmployeeService EmployeeService
@inject INotificationService NotificationService
@inject ISignalRService SignalRService
@inject IGameRestartService GameRestartService
@inject KanbanGamev2.Shared.Services.IGameStateService GameStateService
@inject IFeatureService FeatureService
@inject NavigationManager Navigation
@inject IGlobalLoaderService GlobalLoaderService
@inject IWorkSimulationService WorkSimulationService
@inject IAuthService AuthService
@implements IDisposable
@implements IAsyncDisposable

<PageTitle>Game Master Panel</PageTitle>

<style>
    .gamemaster-header {
        margin-bottom: 24px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e9ecef;
    }

    .gamemaster-header h2 {
        color: #212529;
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .gamemaster-header .crown-icon {
        font-size: 1.25rem;
        color: #ffc107;
    }

    .modern-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
        overflow: hidden;
        background: #ffffff;
    }

    .modern-card-header {
        border: none;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.5rem;
        background: #ffffff;
    }

    .modern-card-header.info {
        border-bottom-color: #ffc107;
    }

    .modern-card-header.success {
        border-bottom-color: #28a745;
    }

    .modern-card-header h5 {
        margin: 0;
        font-weight: 500;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #212529;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modern-card-body {
        padding: 1.5rem;
        background: #ffffff;
    }

    .modern-table {
        margin: 0;
    }

    .modern-table thead th {
        background: #f8f9fa;
        color: #212529;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        padding: 0.75rem 1rem;
        border: none;
        border-bottom: 1px solid #e9ecef;
    }

    .modern-table tbody tr {
        border-bottom: 1px solid #e9ecef;
    }

    .modern-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .modern-table tbody td {
        padding: 1rem;
        vertical-align: middle;
    }

    .employee-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 3px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
    }

    .employee-avatar:hover {
        transform: scale(1.1);
    }

    .modern-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.75rem;
    }

    .modern-btn {
        border-radius: 4px;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border: 1px solid #e9ecef;
        font-size: 0.875rem;
    }

    .modern-btn:hover {
        border-color: #dee2e6;
    }

    .restart-btn {
        background-color: #dc3545 !important;
        color: white !important;
        border-color: #dc3545 !important;
    }

    .restart-btn:hover {
        background-color: #c82333 !important;
        color: white !important;
        border-color: #bd2130 !important;
    }

    .modern-btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }

    .modern-modal {
        border-radius: 16px;
        border: none;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }

    .modern-modal-header {
        border: none;
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
    }

    .modern-modal-body {
        padding: 1.5rem;
    }

    .modern-modal-footer {
        border: none;
        padding: 1.5rem;
        border-top: 1px solid #e9ecef;
        background-color: #f8f9fa;
    }

    .modern-toggle {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
    }

    .modern-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .modern-toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #dee2e6;
        transition: 0.2s;
        border-radius: 24px;
        border: 1px solid #ced4da;
    }

    .modern-toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.2s;
        border-radius: 50%;
        border: 1px solid #ced4da;
    }

    .modern-toggle input:checked + .modern-toggle-slider {
        background-color: #28a745;
        border-color: #28a745;
    }

    .modern-toggle input:checked + .modern-toggle-slider:before {
        transform: translateX(20px);
        border-color: #28a745;
    }

    .feature-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .feature-btn {
        border-radius: 4px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        font-size: 0.875rem;
        border: 1px solid #e9ecef;
        background: #ffffff;
        color: #212529;
        transition: all 0.15s ease;
    }

    .feature-btn:hover {
        border-color: #dee2e6;
        background: #f8f9fa;
    }

    .feature-btn.btn-outline-primary {
        border-color: #2196f3;
        color: #2196f3;
    }

    .feature-btn.btn-outline-primary:hover {
        background: #2196f3;
        color: white;
    }

    .feature-btn.btn-outline-info {
        border-color: #ffc107;
        color: #ffc107;
    }

    .feature-btn.btn-outline-info:hover {
        background: #ffc107;
        color: white;
    }

    .spinner-modern {
        width: 3rem;
        height: 3rem;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .avatar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 1rem;
        max-height: 300px;
        overflow-y: auto;
        padding: 0.5rem;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        background: #f8f9fa;
    }

    .avatar-grid::-webkit-scrollbar {
        width: 6px;
    }

    .avatar-grid::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .avatar-grid::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 10px;
    }

    .avatar-option {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .avatar-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
    }

    .avatar-option.selected {
        border-color: #28a745;
        background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .avatar-preview {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid #e9ecef;
        object-fit: cover;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }

    .avatar-option.selected .avatar-preview {
        border-color: #28a745;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .avatar-name {
        font-size: 0.75rem;
        font-weight: 600;
        color: #495057;
        text-align: center;
        text-transform: capitalize;
    }

    .avatar-check {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.75rem;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }
</style>

@if (!AuthService.IsAuthenticated)
{
    @* Empty page for unauthenticated users *@
}
else
{
<div class="container-fluid" style="padding: 2rem;">
    <div class="gamemaster-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2>
                <i class="oi oi-crown crown-icon"></i> Game Master Panel
            </h2>
            <div class="d-flex gap-2">
                <button class="btn btn-primary modern-btn" @onclick="AdvanceToNextDay" title="Advance to Next Day">
                    <i class="oi oi-arrow-right"></i> Next Day
                </button>
                <button class="btn btn-danger modern-btn restart-btn" @onclick="ShowRestartConfirmation" title="Restart Game - Reset all progress">
                    <i class="oi oi-reload"></i> Restart Game
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header success">
                    <h5>
                        <i class="oi oi-list-rich"></i> Backlog Feature Management
                    </h5>
                </div>
                <div class="card-body modern-card-body">
                    <div class="mb-4">
                        <h6 class="mb-3 fw-bold" style="font-size: 1.1rem;">Add New Feature to Backlog</h6>
                        <div class="feature-buttons">
                            <button class="btn btn-outline-primary feature-btn" @onclick="() => AddFeatureToBacklog(3, 6000)" title="Very Small Feature - 3 Story Points">
                                <i class="oi oi-plus"></i> Very Small
                            </button>
                            <button class="btn btn-outline-primary feature-btn" @onclick="() => AddFeatureToBacklog(5, 10000)" title="Small Feature - 5 Story Points">
                                <i class="oi oi-plus"></i> Small
                            </button>
                            <button class="btn btn-outline-primary feature-btn" @onclick="() => AddFeatureToBacklog(8, 15000)" title="Medium Feature - 8 Story Points">
                                <i class="oi oi-plus"></i> Medium
                            </button>
                            <button class="btn btn-outline-primary feature-btn" @onclick="() => AddFeatureToBacklog(13, 25000)" title="Large Feature - 13 Story Points">
                                <i class="oi oi-plus"></i> Large
                            </button>
                            <button class="btn btn-outline-primary feature-btn" @onclick="() => AddFeatureToBacklog(21, 40000)" title="Very Large Feature - 21 Story Points">
                                <i class="oi oi-plus"></i> Very Large
                            </button>
                            <button class="btn btn-outline-info feature-btn" @onclick="AddTestFeatureToBacklog" title="Test Feature - 1 FE task, 1 BE task">
                                <i class="oi oi-plus"></i> Test Feature
                            </button>
                        </div>
                    </div>

                    <div>
                        <h6 class="mb-3 fw-bold" style="font-size: 1.1rem;">Existing Features</h6>
                        @if (_features == null || _features.Count == 0)
                        {
                            <div class="text-center py-4">
                                <i class="oi oi-list" style="font-size: 3rem; color: #dee2e6;"></i>
                                <p class="text-muted mt-3">No features available. Use the buttons above to add features to backlog.</p>
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table modern-table">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Description</th>
                                            <th>Column</th>
                                            <th>Story Points</th>
                                            <th>Deadline</th>
                                            <th>Profit</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var feature in _features)
                                        {
                                            <tr>
                                                <td><strong>@feature.Title</strong></td>
                                                <td>@feature.Description</td>
                                                <td>
                                                    <span class="badge modern-badge @GetColumnBadgeClass(feature.ColumnId)">@GetColumnName(feature.ColumnId)</span>
                                                </td>
                                                <td>
                                                    <span class="badge modern-badge bg-info">@feature.StoryPoints SP</span>
                                                </td>
                                                <td>
                                                    @if (feature.DueDate.HasValue)
                                                    {
                                                        <small class="@GetDeadlineClass(feature.DueDate.Value)">
                                                            <i class="oi oi-calendar"></i> @GetDeadlineText(feature.DueDate.Value)
                                                        </small>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                                <td>
                                                    <span class="badge modern-badge bg-success">$@feature.Profit.ToString("N0")</span>
                                                </td>
                                                <td>
                                                    @if (feature.ColumnId == "backlog")
                                                    {
                                                        <button class="btn btn-danger modern-btn modern-btn-sm" @onclick="() => RemoveFeature(feature.Id)" title="Remove Feature">
                                                            <i class="oi oi-trash"></i> Remove
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="oi oi-people"></i> Employee Management
                        </h5>
                        <button class="btn btn-success modern-btn" @onclick="ShowHireEmployeeModal" title="Hire New Employee">
                            <i class="oi oi-plus"></i> Hire Employee
                        </button>
                    </div>
                </div>
                <div class="card-body modern-card-body">
                    @if (_employees == null)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-modern mx-auto" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-3">Loading employees...</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table modern-table">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Roles</th>
                                        <th>Seniority</th>
                                        <th>Monthly Wage</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var employee in _employees)
                                    {
                                        <tr class="@(employee.Status == EmployeeStatus.Fired ? "table-danger" : employee.Status == EmployeeStatus.OnVacation ? "table-warning" : employee.Status == EmployeeStatus.Onboarding ? "table-info" : "")">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img src="@GetEmployeeAvatar(employee.Name)" alt="@employee.Name" class="employee-avatar me-3" />
                                                    <div>
                                                        <div class="fw-bold" style="font-size: 1rem;">@employee.Name</div>
                                                        <small class="text-muted" style="font-size: 0.875rem;">@employee.Email</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex gap-1 flex-wrap">
                                                    @foreach (var role in employee.LearnedRoles)
                                                    {
                                                        <span class="badge modern-badge @GetRoleBadgeClass(role)">@GetRoleInitial(role)</span>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge modern-badge @GetSeniorityBadgeClass(employee.Seniority)">
                                                    @employee.Seniority.GetDisplayName()
                                                </span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="fw-bold text-success">$@employee.MonthlyWage.ToString("N0")</span>
                                                    <small class="text-muted">/month</small>
                                                </div>
                                            </td>
                                            <td>
                                                @switch (employee.Status)
                                                {
                                                    case EmployeeStatus.Active:
                                                        <span class="badge modern-badge bg-success">Active</span>
                                                        break;
                                                    case EmployeeStatus.OnVacation:
                                                        <div>
                                                            <span class="badge modern-badge bg-warning mb-1">
                                                                Vacation
                                                            </span>
                                                            @if (employee.VacationEndDate.HasValue)
                                                            {
                                                                var daysLeft = GetDaysLeft(employee.VacationEndDate.Value);
                                                                <div class="small text-muted mt-1">
                                                                    @if (daysLeft > 0)
                                                                    {
                                                                        <span class="text-info">
                                                                            <i class="oi oi-clock"></i> @daysLeft day@(daysLeft == 1 ? "" : "s") left
                                                                        </span>
                                                                    }
                                                                    else if (daysLeft == 0)
                                                                    {
                                                                        <span class="text-success">
                                                                            <i class="oi oi-check"></i> Returns today
                                                                        </span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-danger">
                                                                            <i class="oi oi-warning"></i> Overdue (@Math.Abs(daysLeft) day@(Math.Abs(daysLeft) == 1 ? "" : "s") overdue)
                                                                        </span>
                                                                    }
                                                                </div>
                                                            }
                                                        </div>
                                                        break;
                                                    case EmployeeStatus.Onboarding:
                                                        <div>
                                                            <span class="badge modern-badge bg-info mb-1">
                                                                Onboarding
                                                            </span>
                                                            @if (employee.OnboardingEndDate.HasValue)
                                                            {
                                                                var daysLeft = GetDaysLeft(employee.OnboardingEndDate.Value);
                                                                <div class="small text-muted mt-1">
                                                                    @if (daysLeft > 0)
                                                                    {
                                                                        <span class="text-info">
                                                                            <i class="oi oi-clock"></i> @daysLeft day@(daysLeft == 1 ? "" : "s") left
                                                                        </span>
                                                                    }
                                                                    else if (daysLeft == 0)
                                                                    {
                                                                        <span class="text-success">
                                                                            <i class="oi oi-check"></i> Completes today
                                                                        </span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-success">
                                                                            <i class="oi oi-check"></i> Should be active
                                                                        </span>
                                                                    }
                                                                </div>
                                                            }
                                                        </div>
                                                        break;
                                                    case EmployeeStatus.Fired:
                                                        <span class="badge modern-badge bg-danger">Fired</span>
                                                        break;
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    @if (employee.Status == EmployeeStatus.Active)
                                                    {
                                                        <button class="btn btn-warning modern-btn modern-btn-sm" @onclick="() => ShowVacationModal(employee)" title="Send on Vacation">
                                                            <i class="oi oi-sun"></i>
                                                        </button>
                                                        <button class="btn btn-danger modern-btn modern-btn-sm" @onclick="() => ShowFireModal(employee)" title="Fire Employee">
                                                            <i class="oi oi-x"></i>
                                                        </button>
                                                    }
                                                    else if (employee.Status == EmployeeStatus.OnVacation)
                                                    {
                                                        <button class="btn btn-success modern-btn modern-btn-sm" @onclick="() => EndVacation(employee)" title="End Vacation Early">
                                                            <i class="oi oi-check"></i>
                                                        </button>
                                                    }
                                                    else if (employee.Status == EmployeeStatus.Fired)
                                                    {
                                                        <button class="btn btn-success modern-btn modern-btn-sm" @onclick="() => RehireEmployee(employee)" title="Rehire Employee">
                                                            <i class="oi oi-plus"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header info">
                    <h5>
                        <i class="oi oi-cog"></i> UI Preferences
                    </h5>
                </div>
                <div class="card-body modern-card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="d-flex align-items-start gap-3">
                                <label class="modern-toggle">
                                    <input type="checkbox" id="summaryBoardToggle"
                                           checked="@_isSummaryBoardVisible"
                                    @onchange="OnSummaryBoardVisibilityChanged" />
                                    <span class="modern-toggle-slider"></span>
                                </label>
                                <div>
                                    <label class="form-check-label fw-bold" for="summaryBoardToggle" style="cursor: pointer; font-size: 1rem;">
                                        Show Summary Board in Sidebar
                                    </label>
                                    <div class="form-text text-muted mt-1">
                                        Control whether the Summary Board link appears in the navigation sidebar.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="d-flex align-items-start gap-3">
                                <label class="modern-toggle">
                                    <input type="checkbox" id="readyDevColumnToggle"
                                           checked="@_isReadyForDevelopmentColumnVisible"
                                    @onchange="OnReadyForDevelopmentColumnVisibilityChanged" />
                                    <span class="modern-toggle-slider"></span>
                                </label>
                                <div>
                                    <label class="form-check-label fw-bold" for="readyDevColumnToggle" style="cursor: pointer; font-size: 1rem;">
                                        Show Ready for Development Column
                                    </label>
                                    <div class="form-text text-muted mt-1">
                                        Control whether the "Ready for Development" column appears on the Analysis Board.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



@if (_showVacationModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modern-modal">
                <div class="modal-header modern-modal-header" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                    <h5 class="modal-title fw-bold">
                        <i class="oi oi-sun"></i> Send Employee on Vacation
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseVacationModal"></button>
                </div>
                <div class="modal-body modern-modal-body">
                    <p class="mb-3" style="font-size: 1.1rem;">Send <strong>@_selectedEmployee?.Name</strong> on vacation?</p>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Vacation Duration</label>
                        <select class="form-select" @bind="_vacationDuration" style="border-radius: 8px; padding: 0.75rem;">
                            <option value="7">1 Week</option>
                            <option value="14">2 Weeks</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer modern-modal-footer">
                    <button type="button" class="btn btn-secondary modern-btn" @onclick="CloseVacationModal">Cancel</button>
                    <button type="button" class="btn btn-warning modern-btn" @onclick="SendOnVacation">Send on Vacation</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" style="backdrop-filter: blur(4px);"></div>
}

@if (_showFireModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modern-modal">
                <div class="modal-header modern-modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;">
                    <h5 class="modal-title fw-bold">
                        <i class="oi oi-x"></i> Fire Employee
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseFireModal"></button>
                </div>
                <div class="modal-body modern-modal-body">
                    <div class="alert alert-danger" style="border-radius: 10px; border: none; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);">
                        <h6 class="alert-heading fw-bold">
                            <i class="oi oi-warning"></i> Warning: This action cannot be undone!
                        </h6>
                        <p class="mb-0">Are you sure you want to fire <strong>@_selectedEmployee?.Name</strong>?</p>
                    </div>
                    <p class="text-muted small">
                        The employee will be removed from all boards and their work will be unassigned.
                    </p>
                </div>
                <div class="modal-footer modern-modal-footer">
                    <button type="button" class="btn btn-secondary modern-btn" @onclick="CloseFireModal">Cancel</button>
                    <button type="button" class="btn btn-danger modern-btn" @onclick="FireEmployee">Fire Employee</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" style="backdrop-filter: blur(4px);"></div>
}

@if (_showHireEmployeeModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content modern-modal">
                <div class="modal-header modern-modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                    <h5 class="modal-title fw-bold">
                        <i class="oi oi-plus"></i> Hire New Employee
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseHireEmployeeModal"></button>
                </div>
                <div class="modal-body modern-modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Avatar <span class="text-danger">*</span></label>
                        <div class="form-text text-muted mb-2">Choose an avatar for the employee</div>
                        <div class="avatar-grid">
                            @foreach (var avatarName in GetAvailableAvatars())
                            {
                                var isSelected = _selectedAvatarName == avatarName;
                                <div class="avatar-option @(isSelected ? "selected" : "")" @onclick="() => SelectAvatar(avatarName)">
                                    <img src="@GetEmployeeAvatar(avatarName)" alt="@avatarName" class="avatar-preview" />
                                    <div class="avatar-name">@avatarName</div>
                                    @if (isSelected)
                                    {
                                        <div class="avatar-check">
                                            <i class="oi oi-check"></i>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        @if (string.IsNullOrWhiteSpace(_selectedAvatarName))
                        {
                            <div class="text-danger small mt-2">
                                <i class="oi oi-warning"></i> Please select an avatar
                            </div>
                        }
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Seniority <span class="text-danger">*</span></label>
                        <select class="form-select" @bind="_newEmployeeSeniority" style="border-radius: 8px; padding: 0.75rem;">
                            <option value="@Seniority.Junior">Junior</option>
                            <option value="@Seniority.Mid">Mid-level</option>
                            <option value="@Seniority.Senior">Senior</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Team (Board Type) <span class="text-danger">*</span></label>
                        <select class="form-select" @bind="_newEmployeeBoardType" style="border-radius: 8px; padding: 0.75rem;">
                            <option value="@BoardType.Analysis">Analysis</option>
                            <option value="@BoardType.Backend">Backend</option>
                            <option value="@BoardType.Frontend">Frontend</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Learned Roles <span class="text-danger">*</span></label>
                        <div class="form-text text-muted mb-2">Select roles the employee already knows</div>
                        <div class="d-flex flex-column gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="roleHighLevelAnalyst" checked="@_selectedRoles.Contains(Role.HighLevelAnalyst)" @onchange="@((ChangeEventArgs e) => ToggleRole(Role.HighLevelAnalyst, e.Value))" />
                                <label class="form-check-label" for="roleHighLevelAnalyst">
                                    <span class="badge modern-badge bg-warning">H</span> High Level Analyst
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="roleAnalyst" checked="@_selectedRoles.Contains(Role.Analyst)" @onchange="@((ChangeEventArgs e) => ToggleRole(Role.Analyst, e.Value))" />
                                <label class="form-check-label" for="roleAnalyst">
                                    <span class="badge modern-badge bg-success">A</span> Analyst
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="roleDeveloper" checked="@_selectedRoles.Contains(Role.Developer)" @onchange="@((ChangeEventArgs e) => ToggleRole(Role.Developer, e.Value))" />
                                <label class="form-check-label" for="roleDeveloper">
                                    <span class="badge modern-badge bg-primary">D</span> Developer
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="roleTester" checked="@_selectedRoles.Contains(Role.Tester)" @onchange="@((ChangeEventArgs e) => ToggleRole(Role.Tester, e.Value))" />
                                <label class="form-check-label" for="roleTester">
                                    <span class="badge modern-badge bg-danger">T</span> Tester
                                </label>
                            </div>
                        </div>
                        @if (_selectedRoles.Count == 0)
                        {
                            <div class="text-danger small mt-2">
                                <i class="oi oi-warning"></i> Please select at least one learned role
                            </div>
                        }
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Learnable Roles</label>
                        <div class="form-text text-muted mb-2">Select roles the employee can learn (optional)</div>
                        <div class="d-flex flex-column gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="learnableHighLevelAnalyst" checked="@_selectedLearnableRoles.Contains(Role.HighLevelAnalyst)" @onchange="@((ChangeEventArgs e) => ToggleLearnableRole(Role.HighLevelAnalyst, e.Value))" />
                                <label class="form-check-label" for="learnableHighLevelAnalyst">
                                    <span class="badge modern-badge bg-warning">H</span> High Level Analyst
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="learnableAnalyst" checked="@_selectedLearnableRoles.Contains(Role.Analyst)" @onchange="@((ChangeEventArgs e) => ToggleLearnableRole(Role.Analyst, e.Value))" />
                                <label class="form-check-label" for="learnableAnalyst">
                                    <span class="badge modern-badge bg-success">A</span> Analyst
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="learnableDeveloper" checked="@_selectedLearnableRoles.Contains(Role.Developer)" @onchange="@((ChangeEventArgs e) => ToggleLearnableRole(Role.Developer, e.Value))" />
                                <label class="form-check-label" for="learnableDeveloper">
                                    <span class="badge modern-badge bg-primary">D</span> Developer
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="learnableTester" checked="@_selectedLearnableRoles.Contains(Role.Tester)" @onchange="@((ChangeEventArgs e) => ToggleLearnableRole(Role.Tester, e.Value))" />
                                <label class="form-check-label" for="learnableTester">
                                    <span class="badge modern-badge bg-danger">T</span> Tester
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer modern-modal-footer">
                    <button type="button" class="btn btn-secondary modern-btn" @onclick="CloseHireEmployeeModal">Cancel</button>
                    <button type="button" class="btn btn-success modern-btn" @onclick="HireEmployee" disabled="@(_selectedRoles.Count == 0 || string.IsNullOrWhiteSpace(_selectedAvatarName))">
                        <i class="oi oi-check"></i> Hire Employee
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" style="backdrop-filter: blur(4px);"></div>
}

<RestartConfirmationModal 
    IsVisible="@_showRestartConfirmation" 
    IsVisibleChanged="@((bool value) => _showRestartConfirmation = value)"
    OnRestartConfirmed="RestartGame" />
}
@code {
    private List<Employee>? _employees;
    private bool _showVacationModal = false;
    private bool _showFireModal = false;
    private bool _showHireEmployeeModal = false;
    private bool _showRestartConfirmation = false;
    private Employee? _selectedEmployee;
    private int _vacationDuration = 7;
    private bool _isSummaryBoardVisible = true; // New field for checkbox state
    private bool _isReadyForDevelopmentColumnVisible = true; // New field for ready dev column checkbox state
    private List<Feature>? _features;
    
    // Hire employee form fields
    private string _selectedAvatarName = string.Empty;
    private Seniority _newEmployeeSeniority = Seniority.Junior;
    private BoardType _newEmployeeBoardType = BoardType.Analysis;
    private List<Role> _selectedRoles = new List<Role>();
    private List<Role> _selectedLearnableRoles = new List<Role>();
    
    // Available avatar names
    private readonly List<string> _availableAvatars = new List<string>
    {
        "alex", "alice", "beth", "brian", "charles", "claire", "david", "diana",
        "emma", "ethan", "fiona", "frank", "george", "grace", "hannah", "henry",
        "isaac", "ivy", "jack", "julia", "kevin", "liam", "mark", "nathan",
        "oliver", "paul", "quentin", "ryan", "sam", "tom"
    };

    protected override async Task OnInitializedAsync()
    {
        // Check authentication first
        await AuthService.CheckAuthenticationAsync();
        AuthService.AuthenticationStateChanged += OnAuthenticationStateChanged;
        
        if (AuthService.IsAuthenticated)
        {
            await LoadGameMasterData();
        }
    }

    private async Task LoadGameMasterData()
    {
        await LoadEmployees();
        await LoadFeatures();
        await GameStateService.LoadGameState(); // Load the current game state
        _isSummaryBoardVisible = GameStateService.IsSummaryBoardVisible; // Initialize the checkbox state
        _isReadyForDevelopmentColumnVisible = GameStateService.IsReadyForDevelopmentColumnVisible; // Initialize the ready dev column checkbox state
        SignalRService.EmployeeStatusChanged += OnEmployeeStatusChanged;
        GameStateService.SummaryBoardVisibilityChanged += OnGameStateSummaryBoardVisibilityChanged;
        GameStateService.ReadyForDevelopmentColumnVisibilityChanged += OnGameStateReadyForDevelopmentColumnVisibilityChanged;
    }

    private void OnAuthenticationStateChanged(bool isAuthenticated)
    {
        if (isAuthenticated)
        {
            _ = LoadGameMasterData();
        }
        StateHasChanged();
    }

    private async Task LoadFeatures()
    {
        try
        {
            await FeatureService.GetFeatures();
            // Show all features except delivered ones (where ColumnId contains "done")
            _features = FeatureService.Features
                .Where(f => !f.IsDelivered) // Exclude delivered features
                .OrderBy(f => f.Order)
                .ToList();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading features: {ex.Message}");
        }
    }

    private async Task AddFeatureToBacklog(int storyPoints, decimal profit)
    {
        try
        {
            // Generate feature title (F + next number)
            var existingFeatures = FeatureService.Features;
            var maxOrder = existingFeatures.Any() ? existingFeatures.Max(f => f.Order) : 0;
            var featureNumber = existingFeatures.Count(f => f.ColumnId == "backlog") + 1;
            
            // Calculate deadline: 2-3 days per story point, minimum 7 days, maximum 30 days
            var currentGameDate = GameStateService.GameStartDate.AddDays(GameStateService.CurrentDay - 1);
            var daysUntilDeadline = Math.Max(7, Math.Min(30, storyPoints * 2 + 5));
            var deadline = currentGameDate.AddDays(daysUntilDeadline);
            
            var newFeature = new Feature
            {
                Title = $"F{maxOrder + 1}",
                Description = $"New feature - {GetSizeName(storyPoints)} size",
                Priority = null,
                Status = Status.ToDo,
                AssignedToEmployeeId = null,
                DueDate = deadline,
                StoryPoints = storyPoints,
                ColumnId = "backlog",
                Order = maxOrder + 1,
                LaborIntensity = 1.0,
                LaborLeft = 1.0,
                Profit = profit
            };

            await FeatureService.CreateFeature(newFeature);
            await NotificationService.ShowGlobalNotificationAsync(
                "Feature Added",
                $"Added {GetSizeName(storyPoints)} feature ({storyPoints} SP) to backlog.",
                NotificationType.Success
            );
            
            await LoadFeatures();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding feature: {ex.Message}");
            await NotificationService.ShowGlobalNotificationAsync(
                "Error",
                $"Failed to add feature: {ex.Message}",
                NotificationType.Error
            );
        }
    }

    private async Task AddTestFeatureToBacklog()
    {
        try
        {
            // Generate feature title (F + next number)
            var existingFeatures = FeatureService.Features;
            var maxOrder = existingFeatures.Any() ? existingFeatures.Max(f => f.Order) : 0;
            
            var newFeature = new Feature
            {
                Title = $"F{maxOrder + 1}",
                Description = "Test feature - 1 FE task, 1 BE task",
                Priority = null,
                Status = Status.ToDo,
                AssignedToEmployeeId = null,
                DueDate = null, // Test features have no deadline
                StoryPoints = 1, // Special value to indicate test feature
                ColumnId = "backlog",
                Order = maxOrder + 1,
                LaborIntensity = 1.0,
                LaborLeft = 1.0,
                Profit = 5000
            };

            await FeatureService.CreateFeature(newFeature);
            await NotificationService.ShowGlobalNotificationAsync(
                "Test Feature Added",
                "Added test feature (1 FE task, 1 BE task) to backlog.",
                NotificationType.Success
            );
            
            await LoadFeatures();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding test feature: {ex.Message}");
            await NotificationService.ShowGlobalNotificationAsync(
                "Error",
                $"Failed to add test feature: {ex.Message}",
                NotificationType.Error
            );
        }
    }

    private async Task RemoveFeature(Guid featureId)
    {
        try
        {
            var feature = _features?.FirstOrDefault(f => f.Id == featureId);
            if (feature == null || feature.ColumnId != "backlog") return;

            var success = await FeatureService.DeleteFeature(featureId);
            if (success)
            {
                await NotificationService.ShowGlobalNotificationAsync(
                    "Feature Removed",
                    $"Feature '{feature.Title}' has been removed from backlog.",
                    NotificationType.Info
                );
                await LoadFeatures();
            }
            else
            {
                await NotificationService.ShowGlobalNotificationAsync(
                    "Error",
                    "Failed to remove feature.",
                    NotificationType.Error
                );
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing feature: {ex.Message}");
            await NotificationService.ShowGlobalNotificationAsync(
                "Error",
                $"Failed to remove feature: {ex.Message}",
                NotificationType.Error
            );
        }
    }

    private string GetColumnName(string? columnId)
    {
        if (string.IsNullOrEmpty(columnId))
            return "Unknown";
            
        return columnId switch
        {
            "backlog" => "Backlog",
            "ready-dev" => "Ready for Dev",
            "development" => "Development",
            "done" => "Done",
            _ => columnId
        };
    }

    private string GetColumnBadgeClass(string? columnId)
    {
        if (string.IsNullOrEmpty(columnId))
            return "bg-secondary";
            
        return columnId switch
        {
            "backlog" => "bg-secondary",
            "ready-dev" => "bg-warning",
            "development" => "bg-primary",
            "done" => "bg-success",
            _ => "bg-secondary"
        };
    }

    private string GetSizeName(int storyPoints)
    {
        return storyPoints switch
        {
            3 => "Very Small",
            5 => "Small",
            8 => "Medium",
            13 => "Large",
            21 => "Very Large",
            _ => "Unknown"
        };
    }

    private string GetDeadlineText(DateTime dueDate)
    {
        var currentGameDate = GameStateService.GameStartDate.AddDays(GameStateService.CurrentDay - 1);
        var daysUntilDeadline = (dueDate.Date - currentGameDate.Date).Days;
        
        if (daysUntilDeadline < 0)
        {
            return $"Overdue ({Math.Abs(daysUntilDeadline)} day{(Math.Abs(daysUntilDeadline) == 1 ? "" : "s")} ago)";
        }
        else if (daysUntilDeadline == 0)
        {
            return "Today";
        }
        else if (daysUntilDeadline == 1)
        {
            return "Tomorrow";
        }
        else if (daysUntilDeadline <= 7)
        {
            return $"{daysUntilDeadline} days ({dueDate:MM/dd/yyyy})";
        }
        else
        {
            return dueDate.ToString("MM/dd/yyyy");
        }
    }

    private string GetDeadlineClass(DateTime dueDate)
    {
        var currentGameDate = GameStateService.GameStartDate.AddDays(GameStateService.CurrentDay - 1);
        var daysUntilDeadline = (dueDate.Date - currentGameDate.Date).Days;
        
        if (daysUntilDeadline < 0)
        {
            return "text-danger fw-bold";
        }
        else if (daysUntilDeadline <= 3)
        {
            return "text-danger";
        }
        else
        {
            return "text-muted";
        }
    }

    private async Task LoadEmployees()
    {
        try
        {
            await EmployeeService.GetEmployees();
            _employees = EmployeeService.Employees;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading employees: {ex.Message}");
        }
    }

    private void ShowVacationModal(Employee employee)
    {
        _selectedEmployee = employee;
        _showVacationModal = true;
        StateHasChanged();
    }

    private void CloseVacationModal()
    {
        _showVacationModal = false;
        _selectedEmployee = null;
        StateHasChanged();
    }

    private void ShowFireModal(Employee employee)
    {
        _selectedEmployee = employee;
        _showFireModal = true;
        StateHasChanged();
    }

    private void CloseFireModal()
    {
        _showFireModal = false;
        _selectedEmployee = null;
        StateHasChanged();
    }

    private async Task SendOnVacation()
    {
        if (_selectedEmployee == null) return;

        try
        {
            await EmployeeService.SendEmployeeOnVacationAsync(_selectedEmployee.Id, _vacationDuration);
            await NotificationService.ShowGlobalNotificationAsync(
                "Employee Vacation", 
                $"{_selectedEmployee.Name} has been sent on vacation for {(_vacationDuration == 7 ? "1 week" : "2 weeks")}.", 
                NotificationType.Info
            );
            
            CloseVacationModal();
            await LoadEmployees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending employee on vacation: {ex.Message}");
        }
    }

    private async Task FireEmployee()
    {
        if (_selectedEmployee == null) return;

        try
        {
            await EmployeeService.FireEmployeeAsync(_selectedEmployee.Id);
            await NotificationService.ShowGlobalNotificationAsync(
                "Employee Fired", 
                $"{_selectedEmployee.Name} has been fired from the company.", 
                NotificationType.Warning
            );
            
            CloseFireModal();
            await LoadEmployees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error firing employee: {ex.Message}");
        }
    }

    private async Task EndVacation(Employee employee)
    {
        try
        {
            await EmployeeService.EndEmployeeVacationAsync(employee.Id);
            await NotificationService.ShowGlobalNotificationAsync(
                "Vacation Ended", 
                $"{employee.Name} has returned from vacation and is now active.", 
                NotificationType.Success
            );
            
            await LoadEmployees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error ending vacation: {ex.Message}");
        }
    }

    private async Task RehireEmployee(Employee employee)
    {
        try
        {
            await EmployeeService.RehireEmployeeAsync(employee.Id);
            await NotificationService.ShowGlobalNotificationAsync(
                "Employee Rehired", 
                $"{employee.Name} has been rehired and is now active.", 
                                NotificationType.Success
            );
            
            await LoadEmployees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rehiring employee: {ex.Message}");
        }
    }

    private void OnEmployeeStatusChanged(Employee employee, EmployeeStatus oldStatus, EmployeeStatus newStatus)
    {
        // Refresh the employee list when status changes
        _ = InvokeAsync(async () =>
        {
            await LoadEmployees();
            StateHasChanged();
        });
    }

    private void OnGameStateSummaryBoardVisibilityChanged(bool isVisible)
    {
        _isSummaryBoardVisible = isVisible;
        StateHasChanged();
    }

    private void OnGameStateReadyForDevelopmentColumnVisibilityChanged(bool isVisible)
    {
        _isReadyForDevelopmentColumnVisible = isVisible;
        StateHasChanged();
    }

    private string GetEmployeeAvatar(string employeeName)
    {
        return $"Avatars/{employeeName}.png";
    }

    private string GetRoleBadgeClass(Role role)
    {
        return role switch
        {
            Role.HighLevelAnalyst => "bg-warning",
            Role.Analyst => "bg-success",
            Role.Developer => "bg-primary",
            Role.Tester => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetRoleInitial(Role role)
    {
        return role switch
        {
            Role.HighLevelAnalyst => "H",
            Role.Analyst => "A",
            Role.Developer => "D",
            Role.Tester => "T",
            _ => "?"
        };
    }

    private string GetSeniorityBadgeClass(Seniority seniority)
    {
        return seniority switch
        {
            Seniority.Junior => "bg-info",
            Seniority.Mid => "bg-warning",
            Seniority.Senior => "bg-success",
            _ => "bg-secondary"
        };
    }

    private int GetDaysLeft(DateTime vacationEndDate)
    {
        var now = DateTime.Today;
        var timeLeft = vacationEndDate.Date - now;
        return (int)timeLeft.TotalDays;
    }

    private async Task OnSummaryBoardVisibilityChanged(ChangeEventArgs e)
    {
        if (e.Value is bool isVisible)
        {
            _isSummaryBoardVisible = isVisible;
            await GameStateService.SetSummaryBoardVisibility(_isSummaryBoardVisible);
        }
    }

    private async Task OnReadyForDevelopmentColumnVisibilityChanged(ChangeEventArgs e)
    {
        if (e.Value is bool isVisible)
        {
            _isReadyForDevelopmentColumnVisible = isVisible;
            await GameStateService.SetReadyForDevelopmentColumnVisibility(_isReadyForDevelopmentColumnVisible);
        }
    }

    private void ShowRestartConfirmation()
    {
        _showRestartConfirmation = true;
    }

    private void ShowHireEmployeeModal()
    {
        _selectedAvatarName = string.Empty;
        _newEmployeeSeniority = Seniority.Junior;
        _newEmployeeBoardType = BoardType.Analysis;
        _selectedRoles = new List<Role>();
        _selectedLearnableRoles = new List<Role>();
        _showHireEmployeeModal = true;
        StateHasChanged();
    }

    private void CloseHireEmployeeModal()
    {
        _showHireEmployeeModal = false;
        _selectedAvatarName = string.Empty;
        _selectedRoles = new List<Role>();
        _selectedLearnableRoles = new List<Role>();
        StateHasChanged();
    }

    private List<string> GetAvailableAvatars()
    {
        // Filter out avatars that are already used by existing employees
        var usedNames = _employees?.Select(e => e.Name.ToLower()).ToList() ?? new List<string>();
        return _availableAvatars.Where(a => !usedNames.Contains(a.ToLower())).ToList();
    }

    private void SelectAvatar(string avatarName)
    {
        _selectedAvatarName = avatarName;
        StateHasChanged();
    }

    private void ToggleRole(Role role, object? isChecked)
    {
        if (isChecked is bool checkedValue)
        {
            if (checkedValue)
            {
                if (!_selectedRoles.Contains(role))
                {
                    _selectedRoles.Add(role);
                }
            }
            else
            {
                _selectedRoles.Remove(role);
            }
            StateHasChanged();
        }
    }

    private void ToggleLearnableRole(Role role, object? isChecked)
    {
        if (isChecked is bool checkedValue)
        {
            if (checkedValue)
            {
                if (!_selectedLearnableRoles.Contains(role))
                {
                    _selectedLearnableRoles.Add(role);
                }
            }
            else
            {
                _selectedLearnableRoles.Remove(role);
            }
            StateHasChanged();
        }
    }

    private async Task HireEmployee()
    {
        if (_selectedRoles.Count == 0 || string.IsNullOrWhiteSpace(_selectedAvatarName))
        {
            return;
        }

        try
        {
            // Capitalize first letter of avatar name for employee name
            var employeeName = char.ToUpper(_selectedAvatarName[0]) + _selectedAvatarName.Substring(1);
            var email = $"{_selectedAvatarName.ToLower()}@company.com";

            // Determine column based on learned roles and board type
            var columnId = GetColumnForRoleAndBoard(_selectedRoles, _newEmployeeBoardType);

            // Calculate default wage based on seniority
            var defaultWage = GetDefaultWageForSeniority(_newEmployeeSeniority);

            var newEmployee = new Employee
            {
                Name = employeeName,
                Email = email,
                LearnedRoles = _selectedRoles.ToList(),
                LearnableRoles = _selectedLearnableRoles.ToList(),
                Seniority = _newEmployeeSeniority,
                BoardType = _newEmployeeBoardType,
                Department = Department.Engineering,
                Status = EmployeeStatus.Onboarding,
                IsAvailable = false,
                ColumnId = columnId,
                MonthlyWage = defaultWage,
                OnboardingEndDate = DateTime.Now.AddDays(5)
            };

            await EmployeeService.CreateEmployeeAsync(newEmployee);
            await NotificationService.ShowGlobalNotificationAsync(
                "Employee Hired",
                $"{newEmployee.Name} has been successfully hired!",
                NotificationType.Success
            );

            CloseHireEmployeeModal();
            await LoadEmployees();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error hiring employee: {ex.Message}");
            await NotificationService.ShowGlobalNotificationAsync(
                "Error",
                $"Failed to hire employee: {ex.Message}",
                NotificationType.Error
            );
        }
    }

    private decimal GetDefaultWageForSeniority(Seniority seniority)
    {
        return seniority switch
        {
            Seniority.Junior => 2000,
            Seniority.Mid => 3500,
            Seniority.Senior => 5000,
            _ => 2000
        };
    }

    private string GetColumnForRoleAndBoard(List<Role> learnedRoles, BoardType boardType)
    {
        // Priority: HighLevelAnalyst > Analyst > Developer > Tester
        if (learnedRoles.Contains(Role.HighLevelAnalyst))
        {
            return "analysis1"; // High-level analysts go to analysis board
        }
        else if (learnedRoles.Contains(Role.Analyst))
        {
            return boardType switch
            {
                BoardType.Backend => "backend-analysis",
                BoardType.Frontend => "frontend-analysis",
                _ => "backend-analysis" // Default to backend if Analysis board selected
            };
        }
        else if (learnedRoles.Contains(Role.Developer))
        {
            return boardType switch
            {
                BoardType.Backend => "backend-dev-doing",
                BoardType.Frontend => "frontend-dev-doing",
                _ => "backend-dev-doing" // Default to backend if Analysis board selected
            };
        }
        else if (learnedRoles.Contains(Role.Tester))
        {
            return boardType switch
            {
                BoardType.Backend => "backend-test-doing",
                BoardType.Frontend => "frontend-test-doing",
                _ => "backend-test-doing" // Default to backend if Analysis board selected
            };
        }
        
        // Fallback
        return "analysis1";
    }

    private async Task AdvanceToNextDay()
    {
        try
        {
            GlobalLoaderService.Show("Advancing to Next Day", "Simulating work progress and updating game state...");
            
            // Simulate work for the day
            await WorkSimulationService.SimulateWorkDay();
            
            await SignalRService.AdvanceToNextDayAsync();
            await GameStateService.AdvanceToNextDay();
            
            // Add a small delay to show the loader and make the transition feel more natural
            await Task.Delay(1000);
            
            // Reload employees and features to reflect any changes
            await LoadEmployees();
            await LoadFeatures();
        }
        finally
        {
            GlobalLoaderService.Hide();
        }
    }

    private async Task RestartGame()
    {
        var success = await GameRestartService.RestartGameAsync();
        if (success)
        {
            // Reload the page to show the new state
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
    }

    public void Dispose()
    {
        AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        SignalRService.EmployeeStatusChanged -= OnEmployeeStatusChanged;
        GameStateService.SummaryBoardVisibilityChanged -= OnGameStateSummaryBoardVisibilityChanged;
        GameStateService.ReadyForDevelopmentColumnVisibilityChanged -= OnGameStateReadyForDevelopmentColumnVisibilityChanged;
    }

    public async ValueTask DisposeAsync()
    {
        AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        SignalRService.EmployeeStatusChanged -= OnEmployeeStatusChanged;
        GameStateService.SummaryBoardVisibilityChanged -= OnGameStateSummaryBoardVisibilityChanged;
        GameStateService.ReadyForDevelopmentColumnVisibilityChanged -= OnGameStateReadyForDevelopmentColumnVisibilityChanged;
        await Task.CompletedTask;
    }
} 