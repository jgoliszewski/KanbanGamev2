@page "/analysis-board"
@using KanbanGame.Shared
@using KanbanGamev2.Client.Services
@using KanbanGamev2.Client.Components
@using KanbanGamev2.Shared.Services
@inject IEmployeeService EmployeeService
@inject IFeatureService FeatureService
@inject ISignalRService SignalRService
@inject IGlobalLoaderService GlobalLoaderService
@inject IGameStateService GameStateService
@implements IDisposable

<PageTitle>High Level Analysis Board</PageTitle>

<link href="css/kanban.css" rel="stylesheet" />

<div class="container-fluid">
    <KanbanBoard 
        Title="High Level Analysis Board"
        Description="Track features and employee assignments through the analysis process"
        BoardType="@BoardType.Analysis"
        Columns="@analysisColumns"
        OnCardMoved="@OnCardMoved"
        OnWorkAssigned="@OnWorkAssigned" />
</div>

@code {
    private List<KanbanBoard.KanbanColumnData> analysisColumns = new();


    protected override async Task OnInitializedAsync()
    {
        try
        {
            GlobalLoaderService.Show("Loading Analysis Board", "Initializing board data and connecting to real-time updates...");

            await LoadData();
            OrganizeColumns();

            // Subscribe to real-time board updates
            SignalRService.BoardUpdated += OnBoardUpdated;
            SignalRService.RefreshAllBoards += OnRefreshAllBoards;
            SignalRService.EmployeeMoved += OnEmployeeMoved;
            SignalRService.EmployeeStatusChanged += OnEmployeeStatusChanged;
            GameStateService.ReadyForDevelopmentColumnVisibilityChanged += OnReadyForDevelopmentColumnVisibilityChanged;
        }
        finally
        {
            GlobalLoaderService.Hide();
        }
    }

    private async Task LoadData()
    {
        await EmployeeService.GetEmployees();
        await FeatureService.GetFeatures();
    }

    private void OrganizeColumns()
    {
        analysisColumns = new List<KanbanBoard.KanbanColumnData>
        {
            new KanbanBoard.KanbanColumnData
            {
                Title = "Backlog",
                ColumnId = "backlog",
                Cards = GetCardsByColumn("backlog")
            },
            new KanbanBoard.KanbanColumnData
            {
                Title = "Under Analysis 1",
                ColumnId = "analysis1",
                Cards = GetCardsByColumn("analysis1")
            },
            new KanbanBoard.KanbanColumnData
            {
                Title = "Waiting",
                ColumnId = "waiting",
                Cards = GetCardsByColumn("waiting")
            },
            new KanbanBoard.KanbanColumnData
            {
                Title = "Under Analysis 2",
                ColumnId = "analysis2",
                Cards = GetCardsByColumn("analysis2")
            }
        };

        // Conditionally add the "Ready for Development" column based on the setting
        if (GameStateService.IsReadyForDevelopmentColumnVisible)
        {
            analysisColumns.Add(new KanbanBoard.KanbanColumnData
            {
                Title = "Ready for Development",
                ColumnId = "ready-dev",
                Cards = GetCardsByColumn("ready-dev")
            });
        }
    }

    private List<Card> GetCardsByColumn(string columnId)
    {
        var cards = new List<Card>();

        // Add features for this column
        var features = FeatureService.Features.Where(f => f.ColumnId == columnId).ToList();
        cards.AddRange(features);

        // Add employees for this column
        var employees = EmployeeService.Employees.Where(e => e.ColumnId == columnId).ToList();
        cards.AddRange(employees);

        // Sort cards so employees appear above their assigned work
        return cards;
    }

    private async Task OnCardMoved((Card card, string fromColumn, string toColumn) moveInfo)
    {
        var (card, fromColumn, toColumn) = moveInfo;

        // Update the card's column
        card.ColumnId = toColumn;
        card.UpdatedAt = DateTime.Now;

        // Update the card in the appropriate service
        if (card is Employee employee)
        {
            var oldBoardType = employee.BoardType;
            var newBoardType = BoardType.Analysis;
            
            // Check if employee should be learning in the new column
            bool shouldBeLearning = employee.ShouldBeLearningInColumn(toColumn);
            
            // Check if employee is changing teams (moving to a different board)
            if (oldBoardType != newBoardType)
            {
                // Reset learning state if they were learning
                if (employee.Status == EmployeeStatus.IsLearning)
                {
                    employee.LearningDays = 0;
                    employee.LearningRole = null;
                }
                
                // If moving to different team to learn a role, skip ChangingTeams and start learning
                if (shouldBeLearning)
                {
                    var requiredRole = employee.GetRoleRequiredForColumn(toColumn);
                    employee.Status = EmployeeStatus.IsLearningInOtherTeam; // Set to learning in other team
                    employee.LearningDays = 0;
                    employee.LearningRole = requiredRole;
                    employee.PreviousBoardType = oldBoardType; // Store previous board type
                    employee.BoardType = newBoardType;
                }
                else
                {
                    // Employee is changing teams but not learning - set status to ChangingTeams
                    employee.Status = EmployeeStatus.ChangingTeams;
                    employee.ChangingTeamsDays = 0;
                    employee.PreviousBoardType = oldBoardType;
                    employee.BoardType = newBoardType;
                }
            }
            // Same board - check if employee should be learning
            else if (shouldBeLearning)
            {
                var requiredRole = employee.GetRoleRequiredForColumn(toColumn);
                
                // If moving to a different column or different role, reset learning counter
                if (fromColumn != toColumn || employee.LearningRole != requiredRole)
                {
                    employee.LearningDays = 0;
                }
                
                employee.Status = EmployeeStatus.IsLearning;
                employee.LearningRole = requiredRole;
            }
            else if (employee.Status == EmployeeStatus.IsLearning)
            {
                // If employee was learning but no longer should be, reset learning state
                employee.Status = EmployeeStatus.Active;
                employee.LearningDays = 0;
                employee.LearningRole = null;
            }
            
            await EmployeeService.UpdateEmployee(employee);
        }
        else if (card is Feature movedFeature)
        {
            // If this is a work item being moved, unassign the employee
            if (movedFeature.AssignedToEmployeeId.HasValue)
            {
                var cardsInFromColumn = GetCardsByColumn(fromColumn);
                var assignedEmployee = cardsInFromColumn.FirstOrDefault(x => x.Id == movedFeature.AssignedToEmployeeId.Value && x is Employee);
                if (assignedEmployee is not null)
                {
                    (assignedEmployee! as Employee).AssignedFeatureId = null;
                    await EmployeeService.UpdateEmployee(assignedEmployee as Employee);
                }

                movedFeature.AssignedToEmployeeId = null;
            }

            await FeatureService.UpdateFeature(movedFeature);
        }

        // Reorganize columns to reflect the change
        OrganizeColumns();
        StateHasChanged();
    }

    private async Task OnWorkAssigned((Card workCard, Employee employee) assignmentInfo)
    {
        var (workCard, employee) = assignmentInfo;
        
        // Update the work card (it has already been moved to the employee's column)
        if (workCard is Feature feature)
        {
            await FeatureService.UpdateFeature(feature);
        }
        else if (workCard is KanbanTask task)
        {
            // Note: We'll need to inject ITaskService if we want to update tasks
            // For now, just update the employee
        }
        
        // Update the employee
        await EmployeeService.UpdateEmployee(employee);
        
        // Reorganize columns to reflect the change
        OrganizeColumns();
        StateHasChanged();
        
        // Notify other players about the work assignment
        await SignalRService.NotifyBoardUpdateAsync(BoardType.Analysis.ToString(), employee.ColumnId, workCard);
    }

    private async void OnBoardUpdated(string boardType, string columnId, object cardData)
    {
        // Only handle updates for this board type
        if (boardType == BoardType.Analysis.ToString())
        {
            // Reload data from services to ensure we have the latest state
            await LoadData();
            OrganizeColumns();
            StateHasChanged();
        }
    }

    private async void OnRefreshAllBoards()
    {
        // Reload data from server to ensure we have the latest state
        // This is especially important for vacation status changes
        await EmployeeService.GetEmployees();
        await FeatureService.GetFeatures();
        OrganizeColumns();
        StateHasChanged();
    }

    private async void OnEmployeeMoved(Employee employee, BoardType destinationBoardType, string columnId, BoardType originalBoardType)
    {
        // Refresh this board if it's either the original or destination board
        if (BoardType.Analysis == originalBoardType || BoardType.Analysis == destinationBoardType)
        {
            // Reload data to reflect the employee move
            await LoadData();
            OrganizeColumns();
            StateHasChanged();
        }
    }

    private async void OnEmployeeStatusChanged(Employee employee, EmployeeStatus oldStatus, EmployeeStatus newStatus)
    {
        // When employee status changes, we need to update the board data
        // to reflect the new status (e.g., fired employees disappear, vacation employees are hidden)
        await LoadData();
        OrganizeColumns();
        StateHasChanged();
    }

    private async void OnReadyForDevelopmentColumnVisibilityChanged(bool isVisible)
    {
        await LoadData();
        OrganizeColumns();
        StateHasChanged();
    }

    public void Dispose()
    {
        SignalRService.BoardUpdated -= OnBoardUpdated;
        SignalRService.RefreshAllBoards -= OnRefreshAllBoards;
        SignalRService.EmployeeMoved -= OnEmployeeMoved;
        SignalRService.EmployeeStatusChanged -= OnEmployeeStatusChanged;
        GameStateService.ReadyForDevelopmentColumnVisibilityChanged -= OnReadyForDevelopmentColumnVisibilityChanged;
    }
} 