@page "/summary-board"
@using KanbanGame.Shared
@using KanbanGamev2.Client.Services
@using KanbanGamev2.Client.Components
@inject IFeatureService FeatureService
@inject ISignalRService SignalRService
@inject IGlobalLoaderService GlobalLoaderService
@implements IDisposable

<PageTitle>Summary Board</PageTitle>

<link href="css/kanban.css" rel="stylesheet" />

<div class="container-fluid">
    <KanbanBoard 
        Title="Summary Board"
        Description="High-level overview of all features across the development lifecycle"
        BoardType="@BoardType.Summary"
        Columns="@summaryColumns" />
</div>

@code {
    private List<KanbanBoard.KanbanColumnData> summaryColumns = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            GlobalLoaderService.Show("Loading Summary Board", "Initializing board data and connecting to real-time updates...");
            
        await LoadData();
        OrganizeColumns();
        
        // Subscribe to real-time board updates
        SignalRService.BoardUpdated += OnBoardUpdated;
        SignalRService.RefreshAllBoards += OnRefreshAllBoards;
        }
        finally
        {
            GlobalLoaderService.Hide();
        }
    }

    private async Task LoadData()
    {
        await FeatureService.GetFeatures();
    }

    private void OrganizeColumns()
    {
        summaryColumns = new List<KanbanBoard.KanbanColumnData>
        {
            new KanbanBoard.KanbanColumnData
            {
                Title = "Backlog",
                ColumnId = "backlog",
                Cards = GetFeaturesByColumn("backlog")
            },
            new KanbanBoard.KanbanColumnData
            {
                Title = "During Development",
                ColumnId = "development",
                Cards = GetFeaturesByColumn("development")
            },
            new KanbanBoard.KanbanColumnData
            {
                Title = "Done",
                ColumnId = "done",
                Cards = GetFeaturesByColumn("done")
            }
        };
    }

    private List<Card> GetFeaturesByColumn(string columnId)
    {
        // For summary board, we only show features
        var features = FeatureService.Features.Where(f => f.ColumnId == columnId).ToList();
        return features.Cast<Card>().ToList();
    }

    private async void OnBoardUpdated(string boardType, string columnId, object cardData)
    {
        // Only handle updates for this board type
        if (boardType == BoardType.Summary.ToString())
        {
            // Reload data from services to ensure we have the latest state
            await LoadData();
            OrganizeColumns();
            StateHasChanged();
        }
    }

    private async void OnRefreshAllBoards()
    {
        // Reload data from server to ensure we have the latest state
        // This is especially important for vacation status changes
        await FeatureService.GetFeatures();
        OrganizeColumns();
        StateHasChanged();
    }

    public void Dispose()
    {
        SignalRService.BoardUpdated -= OnBoardUpdated;
        SignalRService.RefreshAllBoards -= OnRefreshAllBoards;
    }
} 