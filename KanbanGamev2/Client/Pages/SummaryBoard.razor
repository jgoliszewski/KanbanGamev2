@page "/summary-board"
@using KanbanGame.Shared
@using KanbanGamev2.Client.Services
@using KanbanGamev2.Client.Components
@inject IFeatureService FeatureService
@inject ITaskService TaskService
@inject ISignalRService SignalRService
@inject IGlobalLoaderService GlobalLoaderService
@implements IDisposable

<PageTitle>Summary Board</PageTitle>

<link href="css/kanban.css" rel="stylesheet" />

<div class="container-fluid">
    <div class="kanban-board">
        <div class="board-header mb-3">
            <h2>Summary</h2>
        </div>
        <div class="board-content">
            <div class="d-flex flex-row" style="gap: 15px;">
                @foreach (var column in summaryColumns)
                {
                    <div class="flex-fill">
                        <div class="kanban-column">
                            <div class="column-header">
                                <h5>@column.Title</h5>
                                <span class="badge bg-secondary">@column.Cards.Count</span>
                            </div>
                            <div class="column-content">
                                @if (column.ColumnId == "development")
                                {
                                    <!-- Custom rendering for development column with tasks -->
                                    @foreach (var card in column.Cards)
                                    {
                                        @if (card is Feature feature)
                                        {
                                            <SummaryFeatureCard Feature="@feature" />
                                        }
                                        else
                                        {
                                            <DraggableCard 
                                                Card="@card" 
                                                ColumnId="@column.ColumnId"
                                                BoardType="@BoardType.Summary"
                                                OnCardMoved="@OnCardMoved"
                                                OnWorkAssigned="@OnWorkAssigned" />
                                        }
                                    }
                                }
                                else
                                {
                                    <!-- Standard rendering for other columns -->
                                    @foreach (var card in column.Cards)
                                    {
                                        <DraggableCard 
                                            Card="@card" 
                                            ColumnId="@column.ColumnId"
                                            BoardType="@BoardType.Summary"
                                            OnCardMoved="@OnCardMoved"
                                            OnWorkAssigned="@OnWorkAssigned" />
                                    }
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<KanbanBoard.KanbanColumnData> summaryColumns = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            GlobalLoaderService.Show("Loading Summary Board", "Initializing board data and connecting to real-time updates...");
            
        await LoadData();
        OrganizeColumns();
        
        // Subscribe to real-time board updates
        SignalRService.BoardUpdated += OnBoardUpdated;
        SignalRService.RefreshAllBoards += OnRefreshAllBoards;
        }
        finally
        {
            GlobalLoaderService.Hide();
        }
    }

    private async Task LoadData()
    {
        await FeatureService.GetFeatures();
        await TaskService.GetTasks();
    }

    private void OrganizeColumns()
    {
        summaryColumns = new List<KanbanBoard.KanbanColumnData>
        {
            new KanbanBoard.KanbanColumnData
            {
                Title = "Backlog",
                ColumnId = "backlog",
                Cards = GetFeaturesByColumn("backlog")
            },
            new KanbanBoard.KanbanColumnData
            {
                Title = "Development",
                ColumnId = "development",
                Cards = GetFeaturesByColumn("development")
            },
            new KanbanBoard.KanbanColumnData
            {
                Title = "Done",
                ColumnId = "done",
                Cards = GetFeaturesByColumn("done")
            }
        };
    }

    private List<Card> GetFeaturesByColumn(string columnId)
    {
        // For summary board, we only show features
        var features = FeatureService.Features.Where(f => f.ColumnId == columnId).ToList();
        return features.Cast<Card>().ToList();
    }
    
    private List<Feature> GetFeaturesInDevelopment()
    {
        return FeatureService.Features.Where(f => f.ColumnId == "development").ToList();
    }

    private async void OnBoardUpdated(string boardType, string columnId, object cardData)
    {
        // Only handle updates for this board type
        if (boardType == BoardType.Summary.ToString())
        {
            // Reload data from services to ensure we have the latest state
            await LoadData();
            OrganizeColumns();
            StateHasChanged();
        }
    }

    private async void OnRefreshAllBoards()
    {
        // Reload data from server to ensure we have the latest state
        // This is especially important for vacation status changes
        await FeatureService.GetFeatures();
        await TaskService.GetTasks();
        OrganizeColumns();
        StateHasChanged();
    }

    private async Task OnCardMoved((Card card, string fromColumn, string toColumn) moveData)
    {
        // Handle card movement if needed
        // For summary board, we might want to prevent certain movements
        await Task.CompletedTask;
    }
    
    private async Task OnWorkAssigned((Card workCard, Employee employee) assignmentData)
    {
        // Handle work assignment if needed
        await Task.CompletedTask;
    }

    public void Dispose()
    {
        SignalRService.BoardUpdated -= OnBoardUpdated;
        SignalRService.RefreshAllBoards -= OnRefreshAllBoards;
    }
} 